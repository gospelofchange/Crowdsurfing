<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crowdsurfing - Community Coordination</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: white;
            overflow: hidden;
            touch-action: manipulation;
            position: relative;
        }
        
        .screen {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: none;
            flex-direction: column;
            z-index: 100;
        }
        
        .screen.active {
            display: flex;
        }
        
        .screen-header {
            display: flex;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            position: relative;
        }
        
        .back-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            backdrop-filter: blur(10px);
        }
        
        .back-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.05);
        }
        
        .screen-title {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            font-size: 20px;
            font-weight: bold;
        }
        
        .screen-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            padding-bottom: 100px;
        }
        
        .container {
            height: 100vh;
            display: flex;
            flex-direction: column;
            padding: 20px 20px 100px 20px;
            max-width: 400px;
            margin: 0 auto;
            position: relative;
        }
        
        .header {
            text-align: center;
            margin-bottom: 20px;
            z-index: 10;
        }
        
        .title {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 8px;
        }
        
        .subtitle {
            font-size: 14px;
            opacity: 0.9;
        }
        
        .card-container {
            flex: 1;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            perspective: 1000px;
        }
        
        .prompt-card {
            width: 100%;
            max-width: 350px;
            height: 420px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(15px);
            border-radius: 25px;
            padding: 30px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            position: absolute;
            cursor: grab;
            transition: transform 0.3s ease, opacity 0.3s ease;
            display: flex;
            flex-direction: column;
            user-select: none;
            touch-action: none;
        }
        
        .prompt-card:active {
            cursor: grabbing;
        }
        
        .prompt-card.swiping {
            transition: none;
        }
        
        .prompt-card.swipe-right {
            transform: translateX(100%) rotate(15deg);
            opacity: 0;
        }
        
        .prompt-card.swipe-left {
            transform: translateX(-100%) rotate(-15deg);
            opacity: 0;
        }
        
        .prompt-text {
            font-size: 22px;
            line-height: 1.4;
            text-align: center;
            margin-bottom: 20px;
            font-weight: 500;
        }
        
        .contributions-section {
            margin: 15px 0;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 15px;
        }
        
        .contribution-group {
            margin-bottom: 12px;
        }
        
        .contribution-label {
            font-size: 12px;
            opacity: 0.8;
            margin-bottom: 6px;
            font-weight: bold;
        }
        
        .contribution-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }
        
        .contribution-tag {
            background: rgba(255, 255, 255, 0.2);
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        
        .swipe-icons {
            display: flex;
            justify-content: center;
            gap: 40px;
            margin: 15px 0;
        }
        
        .swipe-icon {
            font-size: 40px;
            font-weight: bold;
            opacity: 0;
            transition: opacity 0.2s ease, transform 0.2s ease;
            transform: scale(0.8);
        }
        
        .swipe-icon.left {
            color: #ff6b6b;
        }
        
        .swipe-icon.right {
            color: #4CAF50;
        }
        
        .swipe-icon.show {
            opacity: 0.9;
            transform: scale(1.1);
        }
        
        .prompt-details {
            margin-top: auto;
        }
        
        .location-info {
            text-align: center;
            font-size: 16px;
            margin-bottom: 15px;
            opacity: 0.9;
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
        }
        
        .pool-status {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 12px;
            margin-bottom: 15px;
        }
        
        .pool-count {
            background: rgba(255, 255, 255, 0.2);
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 16px;
        }
        
        .progress-bar {
            height: 6px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 15px;
            position: relative;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #ff6b6b, #feca57, #48dbfb, #4CAF50);
            transition: width 0.8s ease;
            border-radius: 3px;
        }
        
        .urgency-pulse {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            animation: urgencyPulse 2s infinite;
            opacity: 0;
        }
        
        .urgency-pulse.active {
            opacity: 1;
        }
        
        @keyframes urgencyPulse {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(200%); }
        }
        
        .time-remaining {
            text-align: center;
            font-size: 14px;
            opacity: 0.8;
            margin-bottom: 10px;
        }
        
        .time-remaining.urgent {
            color: #ff6b6b;
            font-weight: bold;
            animation: urgentBlink 1s infinite alternate;
        }
        
        @keyframes urgentBlink {
            0% { opacity: 0.8; }
            100% { opacity: 1; }
        }
        
        .controls {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-top: 20px;
            z-index: 10;
            margin-bottom: 80px;
        }
        
        .control-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: none;
            font-size: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s ease;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            backdrop-filter: blur(10px);
        }
        
        .control-btn:hover {
            transform: scale(1.1);
        }
        
        .control-btn:active {
            transform: scale(0.95);
        }
        
        .control-btn.reject {
            background: rgba(255, 107, 107, 0.3);
        }
        
        .control-btn.accept {
            background: rgba(76, 175, 80, 0.3);
        }
        
        .trigger-message {
            background: #4CAF50;
            padding: 12px 20px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
            text-align: center;
            margin-top: 10px;
            animation: bounce 1s infinite;
        }
        
        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-5px); }
            60% { transform: translateY(-3px); }
        }
        
        .no-more-cards {
            text-align: center;
            opacity: 0.7;
            margin-top: 50px;
        }
        
        .refresh-btn {
            margin-top: 20px;
            padding: 12px 24px;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 20px;
            color: white;
            cursor: pointer;
            backdrop-filter: blur(10px);
        }
        
        /* Create Contribution Screen Styles */
        .create-form {
            max-width: 100%;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            font-size: 16px;
        }
        
        .form-input, .form-textarea {
            width: 100%;
            padding: 12px 16px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            color: white;
            font-size: 16px;
            box-sizing: border-box;
        }
        
        .form-input::placeholder, .form-textarea::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }
        
        .form-textarea {
            min-height: 80px;
            resize: vertical;
        }
        
        .contribution-input {
            min-height: 60px;
            resize: vertical;
        }
        
        .number-input {
            width: 100px;
        }
        
        .create-btn {
            padding: 15px 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 12px;
            color: white;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s ease;
            width: 100%;
        }
        
        .create-btn:hover {
            transform: translateY(-2px);
        }
        
        .suggestion-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 8px;
        }
        
        .suggestion-chip {
            background: rgba(255, 255, 255, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 6px 12px;
            border-radius: 16px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .suggestion-chip:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: scale(1.05);
        }
        
        /* Intent Contribution Screen Styles */
        .intent-form {
            max-width: 100%;
        }
        
        .intent-group {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .intent-icon {
            font-size: 24px;
            margin-bottom: 10px;
        }
        
        .intent-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 8px;
        }
        
        .intent-description {
            font-size: 14px;
            opacity: 0.8;
            margin-bottom: 15px;
            line-height: 1.4;
        }
        
        .tag-input-container {
            position: relative;
        }
        
        .tags-display {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
            min-height: 30px;
            padding: 10px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.05);
        }
        
        .tag {
            background: rgba(255, 255, 255, 0.2);
            padding: 6px 12px;
            border-radius: 16px;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 6px;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        
        .tag-remove {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 16px;
            opacity: 0.7;
            width: 16px;
            height: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .tag-remove:hover {
            opacity: 1;
        }
        
        .empty-tags {
            color: rgba(255, 255, 255, 0.5);
            font-style: italic;
            font-size: 14px;
        }
        
        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(20px);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            padding: 12px 0 max(12px, env(safe-area-inset-bottom));
            z-index: 1000;
        }
        
        .nav-container {
            display: flex;
            justify-content: space-around;
            align-items: center;
            max-width: 400px;
            margin: 0 auto;
            padding: 0 20px;
        }
        
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
            padding: 8px;
            border-radius: 12px;
            min-width: 50px;
        }
        
        .nav-item:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateY(-2px);
        }
        
        .nav-item.active {
            background: rgba(102, 126, 234, 0.3);
            border: 1px solid rgba(102, 126, 234, 0.5);
        }
        
        .nav-icon {
            font-size: 20px;
            opacity: 0.7;
            transition: opacity 0.2s ease;
        }
        
        .nav-item:hover .nav-icon,
        .nav-item.active .nav-icon {
            opacity: 1;
        }
        
        .nav-label {
            font-size: 10px;
            opacity: 0.6;
            font-weight: 500;
            transition: opacity 0.2s ease;
        }
        
        .nav-item:hover .nav-label,
        .nav-item.active .nav-label {
            opacity: 0.9;
        }
        
        /* Success animations */
        .success-animation {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 48px;
            z-index: 2000;
            animation: successPop 1s ease-out;
            pointer-events: none;
        }
        
        @keyframes successPop {
            0% { transform: translate(-50%, -50%) scale(0); opacity: 0; }
            50% { transform: translate(-50%, -50%) scale(1.2); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(1); opacity: 0; }
        }
    </style>
</head>
<body>
    <!-- Main Screen (Prompt Cards) -->
    <div class="main-screen">
        <div class="container">
            <div class="header">
                <div class="title">Crowdsurfing</div>
                <div class="subtitle">Swipe right if interested ➡️</div>
            </div>
            
            <div class="card-container" id="card-container">
            </div>
            
            <div class="controls">
                <button class="control-btn reject" onclick="app.swipeLeft()">✗</button>
                <button class="control-btn accept" onclick="app.swipeRight()">✓</button>
            </div>
        </div>
    </div>

    <!-- Create Screen -->
    <div class="screen" id="create-screen">
        <div class="screen-header">
            <button class="back-btn" onclick="showMainScreen()">←</button>
            <div class="screen-title">Create Activity</div>
        </div>
        <div class="screen-content">
            <div class="create-form">
                <div class="form-group">
                    <label class="form-label">What do you want to do together?</label>
                    <textarea class="form-textarea" id="create-prompt-text" placeholder="e.g., Want to share travel stories over coffee? ☕"></textarea>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Where should people meet?</label>
                    <input type="text" class="form-input" id="create-prompt-location" placeholder="e.g., By the fountain">
                </div>
                
                <div class="form-group">
                    <label class="form-label">How many people?</label>
                    <input type="number" class="form-input number-input" id="create-prompt-threshold" min="2" max="20" value="3" placeholder="3">
                </div>
                
                <div class="form-group">
                    <label class="form-label">How long will the activity last?</label>
                    <select class="form-input" id="create-activity-duration">
                        <option value="15 minutes">15 minutes</option>
                        <option value="30 minutes">30 minutes</option>
                        <option value="1 hour" selected>1 hour</option>
                        <option value="1.5 hours">1.5 hours</option>
                        <option value="2 hours">2 hours</option>
                        <option value="3 hours">3 hours</option>
                        <option value="Half day">Half day</option>
                        <option value="Full day">Full day</option>
                        <option value="Open-ended">Open-ended</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">How long before this expires?</label>
                    <select class="form-input" id="create-prompt-duration">
                        <option value="1">1 hour</option>
                        <option value="2" selected>2 hours (default)</option>
                        <option value="4">4 hours</option>
                        <option value="6">6 hours</option>
                        <option value="12">12 hours</option>
                        <option value="24">1 day</option>
                        <option value="72">3 days</option>
                        <option value="168">1 week</option>
                    </select>
                </div>
                
                <button class="create-btn" onclick="showIntentScreen()" style="width: 100%; margin-top: 20px;">
                    Next: Add What You're Bringing ✨
                </button>
            </div>
        </div>
    </div>

    <!-- Intent Contribution Screen -->
    <div class="screen" id="intent-screen">
        <div class="screen-header">
            <button class="back-btn" onclick="showCreateScreen()">←</button>
            <div class="screen-title">What You're Contributing</div>
        </div>
        <div class="screen-content">
            <div class="intent-form">
                <div class="intent-group">
                    <div class="intent-icon">🎒</div>
                    <div class="intent-title">I'm bringing...</div>
                    <div class="intent-description">What skills, resources, or energy are you contributing?</div>
                    
                    <div class="tag-input-container">
                        <textarea class="form-textarea contribution-input" id="bringing-input" 
                                placeholder="e.g., guitar skills, homemade cookies, good vibes"></textarea>
                        <div class="tags-display" id="bringing-tags">
                            <div class="empty-tags">Start typing to add what you're bringing...</div>
                        </div>
                    </div>
                    
                    <div class="suggestion-chips" id="bringing-suggestions"></div>
                </div>

                <div class="intent-group">
                    <div class="intent-icon">✨</div>
                    <div class="intent-title">It would be great if we had...</div>
                    <div class="intent-description">What would make this activity even better?</div>
                    
                    <div class="tag-input-container">
                        <textarea class="form-textarea contribution-input" id="needed-input" 
                                placeholder="e.g., other musicians, cozy space, snacks to share"></textarea>
                        <div class="tags-display" id="needed-tags">
                            <div class="empty-tags">What would make this perfect?</div>
                        </div>
                    </div>
                    
                    <div class="suggestion-chips" id="needed-suggestions"></div>
                </div>
                
                <button class="create-btn" onclick="createActivityWithIntent()" style="width: 100%; margin-top: 30px;">
                    Create Activity 🚀
                </button>
            </div>
        </div>
    </div>

    <!-- Profile Screen -->
    <div class="screen" id="profile-screen">
        <div class="screen-header">
            <button class="back-btn" onclick="showMainScreen()">←</button>
            <div class="screen-title">Profile</div>
        </div>
        <div class="screen-content">
            <div style="text-align: center; margin-bottom: 25px;">
                <div style="width: 80px; height: 80px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 50%; margin: 0 auto 15px; display: flex; align-items: center; justify-content: center; font-size: 32px; font-weight: bold;" id="profile-avatar">?</div>
                <div style="opacity: 0.6; font-size: 12px; margin-bottom: 15px;" id="profile-id">Loading...</div>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 25px;">
                <div style="background: rgba(255, 255, 255, 0.05); padding: 12px; border-radius: 10px; text-align: center;">
                    <div style="font-size: 18px; font-weight: bold; margin-bottom: 4px;" id="profile-swipes">0</div>
                    <div style="font-size: 11px; opacity: 0.6;">Activities Joined</div>
                </div>
                <div style="background: rgba(255, 255, 255, 0.05); padding: 12px; border-radius: 10px; text-align: center;">
                    <div style="font-size: 18px; font-weight: bold; margin-bottom: 4px;" id="profile-created">0</div>
                    <div style="font-size: 11px; opacity: 0.6;">Activities Created</div>
                </div>
                <div style="background: rgba(255, 255, 255, 0.05); padding: 12px; border-radius: 10px; text-align: center;">
                    <div style="font-size: 18px; font-weight: bold; margin-bottom: 4px;" id="profile-contributions">0</div>
                    <div style="font-size: 11px; opacity: 0.6;">Contributions Made</div>
                </div>
                <div style="background: rgba(255, 255, 255, 0.05); padding: 12px; border-radius: 10px; text-align: center;">
                    <div style="font-size: 18px; font-weight: bold; margin-bottom: 4px;" id="profile-reputation">✨</div>
                    <div style="font-size: 11px; opacity: 0.6;">Community Standing</div>
                </div>
            </div>
            
            <div style="background: rgba(255, 255, 255, 0.1); padding: 20px; border-radius: 15px;">
                <h3 style="margin-bottom: 15px;">Recent Activity</h3>
                <div id="recent-activity">
                    <div style="opacity: 0.7; text-align: center; padding: 20px;">
                        Start joining activities to see your impact here!
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bottom Navigation -->
    <div class="bottom-nav">
        <div class="nav-container">
            <div class="nav-item" onclick="showProfile()">
                <div class="nav-icon">👤</div>
                <div class="nav-label">Profile</div>
            </div>
            <div class="nav-item" onclick="showCreateScreen()">
                <div class="nav-icon">💡</div>
                <div class="nav-label">Create</div>
            </div>
            <div class="nav-item" onclick="showMainScreen()">
                <div class="nav-icon">🌊</div>
                <div class="nav-label">Discover</div>
            </div>
        </div>
    </div>

    <script>
        console.log('🌊 Starting Crowdsurfing App v2.0...');

        // =============================================================================
        // TDD-BASED MODELS (From our previous implementation)
        // =============================================================================

        class IntentContribution {
            constructor({ bringing = [], needed = [] }) {
                this.bringing = bringing;
                this.needed = needed;
                this.tags = this._generateTags();
                this.createdAt = Date.now();
                this.id = this._generateId();
            }

            _generateTags() {
                const allItems = [...this.bringing, ...this.needed];
                const tags = new Set();

                allItems.forEach(item => {
                    const words = item.toLowerCase()
                        .replace(/[^\w\s]/g, '')
                        .split(/\s+/);
                    
                    words.forEach(word => {
                        if (word.length > 2) {
                            tags.add(word);
                        }
                    });

                    // Add category tags
                    if (this._containsKeywords(item, ['cook', 'food', 'eat', 'meal', 'kitchen'])) {
                        tags.add('food');
                    }
                    if (this._containsKeywords(item, ['music', 'guitar', 'drum', 'sing', 'band'])) {
                        tags.add('music');
                    }
                    if (this._containsKeywords(item, ['teach', 'learn', 'skill', 'knowledge'])) {
                        tags.add('learning');
                    }
                    if (this._containsKeywords(item, ['discuss', 'talk', 'conversation', 'philosophy'])) {
                        tags.add('discussion');
                    }
                });

                return Array.from(tags);
            }

            _containsKeywords(text, keywords) {
                const lowerText = text.toLowerCase();
                return keywords.some(keyword => lowerText.includes(keyword));
            }

            _generateId() {
                return 'contrib_' + Math.random().toString(36).substr(2, 9);
            }

            calculateValue() {
                const bringingValue = this.bringing.reduce((sum, item) => {
                    const skillIndicators = ['skill', 'experience', 'professional', 'advanced'];
                    const hasSkill = skillIndicators.some(indicator => 
                        item.toLowerCase().includes(indicator)
                    );
                    return sum + (hasSkill ? 10 : 5);
                }, 0);

                const demandValue = this.needed.length * 2;
                return bringingValue + demandValue;
            }

            isValid() {
                return this.bringing.length > 0 || this.needed.length > 0;
            }

            toJSON() {
                return {
                    id: this.id,
                    bringing: this.bringing,
                    needed: this.needed,
                    tags: this.tags,
                    value: this.calculateValue(),
                    createdAt: this.createdAt
                };
            }
        }

        class Commitment {
            constructor({ text, location, threshold, duration = 2, activityDuration = '1 hour' }) {
                this.id = Date.now();
                this.text = text;
                this.location = location;
                this.threshold = threshold;
                this.duration = duration;
                this.activityDuration = activityDuration;
                this.createdAt = Date.now();
                this.swipes = [];
                this.contributions = [];
                this.triggered = false;
                this.expired = false;
                this.creator = null;
            }

            addContribution(contribution) {
                this.contributions.push(contribution);
            }

            addSwipe(userId) {
                if (!this.swipes.includes(userId)) {
                    this.swipes.push(userId);
                }
            }

            calculateVoucherPotential() {
                return this.contributions.reduce((total, contrib) => {
                    return total + contrib.calculateValue();
                }, 0);
            }

            getProgress() {
                const socialThreshold = this.swipes.length / this.threshold;
                const economicViability = Math.min(this.calculateVoucherPotential() / (this.threshold * 10), 1);
                
                return {
                    socialThreshold,
                    economicViability,
                    combined: Math.min(socialThreshold + economicViability * 0.3, 1)
                };
            }

            isReadyToTrigger() {
                const progress = this.getProgress();
                return progress.socialThreshold >= 1 && progress.economicViability > 0.5;
            }

            getDecayProgress() {
                const now = Date.now();
                const age = now - this.createdAt;
                const duration = this.duration * 60 * 60 * 1000;
                return Math.min(age / duration, 1);
            }

            getTimeRemaining() {
                const remaining = this.duration * 60 * 60 * 1000 - (Date.now() - this.createdAt);
                if (remaining <= 0) return 'Expired';
                
                const hours = Math.floor(remaining / (60 * 60 * 1000));
                const minutes = Math.floor((remaining % (60 * 60 * 1000)) / (60 * 1000));
                
                if (hours > 0) return `${hours}h ${minutes}m left`;
                return `${minutes}m left`;
            }

            isExpired() {
                return this.getDecayProgress() >= 1;
            }
        }

        // Invisible Economics Engine
        class VoucherEngine {
            constructor() {
                this.pools = new Map();
                this.vouchers = new Map();
            }

            generateVouchers(contribution) {
                // This runs invisibly - users never see voucher details
                const vouchers = [];
                contribution.bringing.forEach((item, index) => {
                    const voucher = {
                        id: `voucher_${contribution.id}_${index}`,
                        type: this._categorizeContribution(item),
                        value: this._calculateItemValue(item),
                        description: item,
                        stakable: true
                    };
                    vouchers.push(voucher);
                });
                return vouchers;
            }

            _categorizeContribution(item) {
                const lower = item.toLowerCase();
                if (lower.includes('skill') || lower.includes('experience')) return 'skill';
                if (lower.includes('space') || lower.includes('room')) return 'space';
                if (lower.includes('tool') || lower.includes('equipment')) return 'equipment';
                if (lower.includes('food') || lower.includes('cook')) return 'food';
                return 'general';
            }

            _calculateItemValue(item) {
                let baseValue = 10;
                const lower = item.toLowerCase();
                if (lower.includes('professional')) baseValue *= 3;
                else if (lower.includes('experience')) baseValue *= 2;
                return Math.round(baseValue);
            }

            getTimeUrgency(commitment) {
                const decayProgress = commitment.getDecayProgress();
                if (decayProgress > 0.7) return 'high';
                if (decayProgress > 0.4) return 'medium';
                return 'low';
            }
        }

        // Contribution Parser for UI
        class ContributionParser {
            parse(input) {
                return {
                    bringing: this._parseItems(input.bringing),
                    needed: this._parseItems(input.needed)
                };
            }

            _parseItems(text) {
                if (!text) return [];
                return text.split(/[,\n]/).map(item => item.trim()).filter(item => item.length > 0);
            }

            getSuggestions(query, type = 'bringing') {
                const suggestions = {
                    bringing: {
                        'cook': ['🍳 cooking skills', '🥘 homemade food', '🔥 portable stove', '🍽️ serving dishes'],
                        'music': ['🎸 guitar skills', '🥁 drumsticks', '🎤 microphone', '🎹 keyboard'],
                        'tech': ['💻 laptop', '🔌 power bank', '📱 mobile hotspot', '🖥️ monitor'],
                        'art': ['🎨 art supplies', '✏️ drawing skills', '📸 camera', '🖼️ display space'],
                        'learn': ['📚 teaching experience', '🧠 knowledge sharing', '📝 note-taking', '❓ curious questions']
                    },
                    needed: {
                        'cook': ['🍽️ hungry people', '🏠 kitchen space', '🥗 fresh ingredients', '🧽 cleanup help'],
                        'music': ['👥 other musicians', '🎵 song suggestions', '🔊 amplification', '👂 good listeners'],
                        'tech': ['💡 project ideas', '🐛 testing help', '📊 feedback', '☕ caffeine'],
                        'art': ['🖼️ display space', '👁️ creative eyes', '💬 constructive feedback', '✨ inspiration'],
                        'learn': ['🤔 curious minds', '❓ great questions', '📚 different perspectives', '☕ discussion fuel']
                    }
                };

                const matches = [];
                const typeSet = suggestions[type] || suggestions.bringing;
                
                for (const [key, items] of Object.entries(typeSet)) {
                    if (key.includes(query.toLowerCase()) || query.toLowerCase().includes(key)) {
                        matches.push(...items);
                    }
                }

                return matches.slice(0, 6); // Limit suggestions
            }
        }

        // =============================================================================
        // MAIN APPLICATION
        // =============================================================================

        class CrowdsurfingApp {
            constructor() {
                this.commitments = new Map();
                this.userSwipes = new Set();
                this.currentIndex = 0;
                this.currentCard = null;
                this.isAnimating = false;
                this.userId = this.generateUserId();
                this.voucherEngine = new VoucherEngine();
                this.contributionParser = new ContributionParser();
                
                // User stats
                this.userStats = this.loadUserStats();
                
                // Current activity being created
                this.currentActivity = null;
                
                this.init();
            }

            init() {
                console.log('🎯 Initializing Crowdsurfing App...');
                this.loadData();
                this.setupSwipeGestures();
                this.setupContributionInputs();
                this.renderCurrentCard();
                this.startUpdateTimer();
                this.updateProfile();
                console.log('✅ App initialized successfully!');
            }

            generateUserId() {
                let userId = localStorage.getItem('crowdsurfing-userId');
                if (!userId) {
                    userId = 'user_' + Math.random().toString(36).substr(2, 9);
                    localStorage.setItem('crowdsurfing-userId', userId);
                }
                return userId;
            }

            loadUserStats() {
                const stats = localStorage.getItem('crowdsurfing-stats');
                if (stats) {
                    return JSON.parse(stats);
                }
                return {
                    activitiesJoined: 0,
                    activitiesCreated: 0,
                    contributionsMade: 0,
                    reputationScore: 0
                };
            }

            saveUserStats() {
                localStorage.setItem('crowdsurfing-stats', JSON.stringify(this.userStats));
            }

            loadData() {
                const saved = localStorage.getItem('crowdsurfing-commitments');
                if (saved) {
                    const data = JSON.parse(saved);
                    data.forEach(commitmentData => {
                        const commitment = new Commitment(commitmentData);
                        commitment.contributions = commitmentData.contributions?.map(c => 
                            new IntentContribution(c)
                        ) || [];
                        commitment.swipes = commitmentData.swipes || [];
                        commitment.triggered = commitmentData.triggered || false;
                        this.commitments.set(commitment.id, commitment);
                    });
                } else {
                    // Create initial sample activities
                    this.createSampleActivities();
                }

                const savedSwipes = localStorage.getItem('crowdsurfing-swipes');
                if (savedSwipes) {
                    this.userSwipes = new Set(JSON.parse(savedSwipes));
                }

                const savedIndex = localStorage.getItem('crowdsurfing-index');
                if (savedIndex) {
                    this.currentIndex = parseInt(savedIndex);
                }
            }

            createSampleActivities() {
                const samples = [
                    {
                        text: "Want to jam with random instruments? 🎵",
                        location: "Near the musicians area",
                        threshold: 3,
                        contributions: {
                            bringing: "rhythm experience, drumsticks",
                            needed: "other musicians, good vibes"
                        }
                    },
                    {
                        text: "Philosophy discussion about AI consciousness 🤖",
                        location: "Quiet corner of the park",
                        threshold: 4,
                        contributions: {
                            bringing: "deep questions, curious mind",
                            needed: "different perspectives, coffee"
                        }
                    },
                    {
                        text: "Impromptu cooking workshop 👨‍🍳",
                        location: "Community kitchen",
                        threshold: 5,
                        contributions: {
                            bringing: "chef skills, recipe ideas",
                            needed: "hungry participants, ingredients"
                        }
                    }
                ];

                samples.forEach(sample => {
                    const commitment = new Commitment(sample);
                    const parsed = this.contributionParser.parse(sample.contributions);
                    const contribution = new IntentContribution(parsed);
                    commitment.addContribution(contribution);
                    this.commitments.set(commitment.id, commitment);
                });
            }

            saveData() {
                const data = Array.from(this.commitments.values()).map(c => ({
                    ...c,
                    contributions: c.contributions.map(contrib => contrib.toJSON())
                }));
                localStorage.setItem('crowdsurfing-commitments', JSON.stringify(data));
                localStorage.setItem('crowdsurfing-swipes', JSON.stringify([...this.userSwipes]));
                localStorage.setItem('crowdsurfing-index', this.currentIndex.toString());
            }

            getCurrentCommitment() {
                const commitments = Array.from(this.commitments.values())
                    .filter(c => !c.triggered && !c.isExpired() && !this.userSwipes.has(c.id));
                
                return commitments[this.currentIndex] || null;
            }

            renderCurrentCard() {
                console.log('🎨 Rendering current card...');
                const container = document.getElementById('card-container');
                
                const existingCard = container.querySelector('.prompt-card');
                if (existingCard) {
                    existingCard.remove();
                }

                const commitment = this.getCurrentCommitment();
                if (!commitment) {
                    this.showNoMoreCards();
                    return;
                }

                const card = document.createElement('div');
                card.className = 'prompt-card';
                this.currentCard = card;

                const progress = commitment.getProgress();
                const progressPercent = Math.round(progress.socialThreshold * 100);
                const urgency = this.voucherEngine.getTimeUrgency(commitment);
                
                // Build contributions display
                let contributionsHtml = '';
                if (commitment.contributions.length > 0) {
                    const contrib = commitment.contributions[0];
                    contributionsHtml = `
                        <div class="contributions-section">
                            ${contrib.bringing.length > 0 ? `
                                <div class="contribution-group">
                                    <div class="contribution-label">🎒 Bringing:</div>
                                    <div class="contribution-tags">
                                        ${contrib.bringing.map(item => `<span class="contribution-tag">${item}</span>`).join('')}
                                    </div>
                                </div>
                            ` : ''}
                            ${contrib.needed.length > 0 ? `
                                <div class="contribution-group">
                                    <div class="contribution-label">✨ Would be great:</div>
                                    <div class="contribution-tags">
                                        ${contrib.needed.map(item => `<span class="contribution-tag">${item}</span>`).join('')}
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    `;
                }

                card.innerHTML = `
                    <div class="prompt-text">${commitment.text}</div>
                    ${contributionsHtml}
                    <div class="swipe-icons">
                        <div class="swipe-icon left">✗</div>
                        <div class="swipe-icon right">✓</div>
                    </div>
                    <div class="prompt-details">
                        <div class="location-info">📍 ${commitment.location}</div>
                        ${commitment.activityDuration ? `<div style="text-align: center; font-size: 14px; margin-bottom: 15px; opacity: 0.8; background: rgba(255,255,255,0.1); padding: 6px 12px; border-radius: 12px;">⏱️ ${commitment.activityDuration}</div>` : ''}
                        <div class="pool-status">
                            <div class="pool-count">${commitment.swipes.length}/${commitment.threshold} interested</div>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${progressPercent}%"></div>
                            <div class="urgency-pulse ${urgency === 'high' ? 'active' : ''}"></div>
                        </div>
                        <div class="time-remaining ${urgency === 'high' ? 'urgent' : ''}">${commitment.getTimeRemaining()}</div>
                        ${commitment.isReadyToTrigger() ? '<div class="trigger-message">Group ready! Activity happening! 🚀</div>' : ''}
                    </div>
                `;

                container.appendChild(card);
                console.log('✅ Card rendered successfully!');
            }

            setupSwipeGestures() {
                const container = document.getElementById('card-container');
                let startX = 0;
                let currentX = 0;
                let isDragging = false;

                const handleStart = (clientX) => {
                    if (this.isAnimating) return;
                    startX = clientX;
                    currentX = clientX;
                    isDragging = true;
                    if (this.currentCard) {
                        this.currentCard.classList.add('swiping');
                    }
                };

                const handleMove = (clientX) => {
                    if (!isDragging || this.isAnimating) return;
                    currentX = clientX;
                    const diffX = currentX - startX;
                    const rotation = diffX * 0.1;
                    
                    if (this.currentCard) {
                        this.currentCard.style.transform = `translateX(${diffX}px) rotate(${rotation}deg)`;
                    }

                    if (this.currentCard) {
                        const leftIcon = this.currentCard.querySelector('.swipe-icon.left');
                        const rightIcon = this.currentCard.querySelector('.swipe-icon.right');
                        
                        if (diffX < -50) {
                            leftIcon.classList.add('show');
                            rightIcon.classList.remove('show');
                        } else if (diffX > 50) {
                            rightIcon.classList.add('show');
                            leftIcon.classList.remove('show');
                        } else {
                            leftIcon.classList.remove('show');
                            rightIcon.classList.remove('show');
                        }
                    }
                };

                const handleEnd = () => {
                    if (!isDragging || this.isAnimating) return;
                    isDragging = false;
                    
                    const diffX = currentX - startX;
                    
                    if (this.currentCard) {
                        const leftIcon = this.currentCard.querySelector('.swipe-icon.left');
                        const rightIcon = this.currentCard.querySelector('.swipe-icon.right');
                        leftIcon.classList.remove('show');
                        rightIcon.classList.remove('show');
                    }

                    if (Math.abs(diffX) > 100) {
                        if (diffX > 0) {
                            this.swipeRight();
                        } else {
                            this.swipeLeft();
                        }
                    } else {
                        if (this.currentCard) {
                            this.currentCard.classList.remove('swiping');
                            this.currentCard.style.transform = '';
                        }
                    }
                };

                container.addEventListener('touchstart', (e) => {
                    handleStart(e.touches[0].clientX);
                }, { passive: true });

                container.addEventListener('touchmove', (e) => {
                    handleMove(e.touches[0].clientX);
                }, { passive: true });

                container.addEventListener('touchend', handleEnd, { passive: true });

                container.addEventListener('mousedown', (e) => {
                    handleStart(e.clientX);
                });

                container.addEventListener('mousemove', (e) => {
                    handleMove(e.clientX);
                });

                container.addEventListener('mouseup', handleEnd);
                container.addEventListener('mouseleave', handleEnd);
            }

            swipeLeft() {
                if (this.isAnimating) return;
                console.log('👈 Swiping left');
                this.animateSwipe('left', false);
            }

            swipeRight() {
                if (this.isAnimating) return;
                console.log('👉 Swiping right');
                const commitment = this.getCurrentCommitment();
                if (commitment && !commitment.isExpired()) {
                    this.handleSwipe(commitment.id, true);
                }
                this.animateSwipe('right', true);
            }

            animateSwipe(direction, liked) {
                if (!this.currentCard) return;
                
                this.isAnimating = true;
                this.currentCard.classList.remove('swiping');
                this.currentCard.classList.add(`swipe-${direction}`);

                setTimeout(() => {
                    this.nextCard();
                    this.isAnimating = false;
                }, 300);
            }

            handleSwipe(commitmentId, liked) {
                const commitment = this.commitments.get(commitmentId);
                if (!commitment || commitment.isExpired()) return;

                if (liked) {
                    this.userSwipes.add(commitmentId);
                    commitment.addSwipe(this.userId);
                    
                    // Update stats
                    this.userStats.activitiesJoined++;
                    this.saveUserStats();
                    
                    // Show success animation
                    this.showSuccessAnimation('❤️');

                    // Check if ready to trigger
                    if (commitment.isReadyToTrigger() && !commitment.triggered) {
                        this.triggerCommitment(commitment);
                    }
                }

                this.saveData();
            }

            triggerCommitment(commitment) {
                commitment.triggered = true;
                console.log('🎉 Activity triggered!', commitment.text);
                
                // Show success animation
                this.showSuccessAnimation('🚀');
                
                // In real app: create Telegram group, distribute vouchers, etc.
                setTimeout(() => {
                    this.showNotification(`🎉 Activity "${commitment.text}" is happening! Group chat created!`);
                }, 1000);
            }

            showSuccessAnimation(emoji) {
                const animation = document.createElement('div');
                animation.className = 'success-animation';
                animation.textContent = emoji;
                document.body.appendChild(animation);
                
                setTimeout(() => {
                    document.body.removeChild(animation);
                }, 1000);
            }

            showNotification(message) {
                if ('Notification' in window && Notification.permission === 'granted') {
                    new Notification(message);
                } else {
                    console.log('📢', message);
                }
            }

            nextCard() {
                this.currentIndex++;
                this.saveData();
                this.renderCurrentCard();
            }

            showNoMoreCards() {
                const container = document.getElementById('card-container');
                container.innerHTML = `
                    <div class="no-more-cards">
                        <h3>All caught up! 🎉</h3>
                        <p>Check back later for new activities</p>
                        <button class="refresh-btn" onclick="app.restart()">Start over</button>
                    </div>
                `;
            }

            restart() {
                this.currentIndex = 0;
                this.saveData();
                this.renderCurrentCard();
            }

            startUpdateTimer() {
                setInterval(() => {
                    // Update time remaining and check for triggers
                    const commitment = this.getCurrentCommitment();
                    if (commitment && this.currentCard) {
                        this.renderCurrentCard();
                    }
                    
                    // Check all commitments for triggers
                    this.checkAllCommitmentsForTriggers();
                }, 10000); // Update every 10 seconds
            }

            checkAllCommitmentsForTriggers() {
                for (const commitment of this.commitments.values()) {
                    if (!commitment.triggered && commitment.isReadyToTrigger()) {
                        this.triggerCommitment(commitment);
                    }
                }
            }

            setupContributionInputs() {
                const bringingInput = document.getElementById('bringing-input');
                const neededInput = document.getElementById('needed-input');

                if (bringingInput) {
                    bringingInput.addEventListener('input', () => {
                        this.updateContributionTags('bringing');
                        this.updateSuggestions('bringing');
                    });
                }

                if (neededInput) {
                    neededInput.addEventListener('input', () => {
                        this.updateContributionTags('needed');
                        this.updateSuggestions('needed');
                    });
                }
            }

            updateContributionTags(type) {
                const input = document.getElementById(`${type}-input`);
                const tagsContainer = document.getElementById(`${type}-tags`);
                
                if (!input || !tagsContainer) return;
                
                const text = input.value;
                const items = this.contributionParser._parseItems(text);
                
                if (items.length === 0) {
                    tagsContainer.innerHTML = `<div class="empty-tags">${type === 'bringing' ? 'Start typing to add what you\'re bringing...' : 'What would make this perfect?'}</div>`;
                    return;
                }
                
                tagsContainer.innerHTML = items.map(item => `
                    <div class="tag">
                        ${item}
                        <button class="tag-remove" onclick="app.removeContributionTag('${type}', '${item.replace(/'/g, '\\\'')}')">&times;</button>
                    </div>
                `).join('');
            }

            removeContributionTag(type, item) {
                const input = document.getElementById(`${type}-input`);
                if (!input) return;
                
                const items = this.contributionParser._parseItems(input.value);
                const filtered = items.filter(i => i !== item);
                input.value = filtered.join(', ');
                this.updateContributionTags(type);
            }

            updateSuggestions(type) {
                const input = document.getElementById(`${type}-input`);
                const suggestionsContainer = document.getElementById(`${type}-suggestions`);
                
                if (!input || !suggestionsContainer) return;
                
                const lastWord = input.value.split(/[,\n]/).pop().trim().toLowerCase();
                if (lastWord.length < 2) {
                    suggestionsContainer.innerHTML = '';
                    return;
                }
                
                const suggestions = this.contributionParser.getSuggestions(lastWord, type);
                suggestionsContainer.innerHTML = suggestions.map(suggestion => `
                    <div class="suggestion-chip" onclick="app.addSuggestion('${type}', '${suggestion.replace(/'/g, '\\\'')}')">
                        ${suggestion}
                    </div>
                `).join('');
            }

            addSuggestion(type, suggestion) {
                const input = document.getElementById(`${type}-input`);
                if (!input) return;
                
                const items = this.contributionParser._parseItems(input.value);
                const cleanSuggestion = suggestion.replace(/^[🎵🍳🎸🥁🎤🎹💻🔌📱🖥️🎨✏️📸🖼️📚🧠📝❓🍽️🏠🥗🧽👥🔊👂💡🐛📊☕🤔📚✨👁️💬]/g, '').trim();
                
                if (!items.includes(cleanSuggestion)) {
                    items.push(cleanSuggestion);
                    input.value = items.join(', ');
                    this.updateContributionTags(type);
                }
                
                // Clear suggestions
                document.getElementById(`${type}-suggestions`).innerHTML = '';
            }

            updateProfile() {
                const initials = this.userId.substring(5, 7).toUpperCase();
                
                document.getElementById('profile-avatar').textContent = initials;
                document.getElementById('profile-id').textContent = this.userId;
                document.getElementById('profile-swipes').textContent = this.userStats.activitiesJoined;
                document.getElementById('profile-created').textContent = this.userStats.activitiesCreated;
                document.getElementById('profile-contributions').textContent = this.userStats.contributionsMade;
                
                const reputationLevel = this.calculateReputationLevel();
                document.getElementById('profile-reputation').textContent = reputationLevel;
            }

            calculateReputationLevel() {
                const total = this.userStats.activitiesJoined + this.userStats.activitiesCreated;
                if (total >= 20) return '🌟';
                if (total >= 10) return '⭐';
                if (total >= 5) return '✨';
                return '🌱';
            }
        }

        // =============================================================================
        // GLOBAL FUNCTIONS
        // =============================================================================

        function showMainScreen() {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
        }

        function showCreateScreen() {
            showMainScreen();
            document.getElementById('create-screen').classList.add('active');
        }

        function showIntentScreen() {
            // Store current activity data
            app.currentActivity = {
                text: document.getElementById('create-prompt-text').value.trim(),
                location: document.getElementById('create-prompt-location').value.trim(),
                threshold: parseInt(document.getElementById('create-prompt-threshold').value),
                duration: parseInt(document.getElementById('create-prompt-duration').value),
                activityDuration: document.getElementById('create-activity-duration').value
            };

            if (!app.currentActivity.text || !app.currentActivity.location) {
                alert('Please fill in the activity description and location first!');
                return;
            }

            showMainScreen();
            document.getElementById('intent-screen').classList.add('active');
            
            // Clear previous inputs
            document.getElementById('bringing-input').value = '';
            document.getElementById('needed-input').value = '';
            app.updateContributionTags('bringing');
            app.updateContributionTags('needed');
        }

        function createActivityWithIntent() {
            const bringing = document.getElementById('bringing-input').value.trim();
            const needed = document.getElementById('needed-input').value.trim();
            
            if (!bringing && !needed) {
                alert('Please add what you\'re bringing or what would be great to have!');
                return;
            }

            // Create the commitment with contributions
            const commitment = new Commitment(app.currentActivity);
            
            if (bringing || needed) {
                const parsed = app.contributionParser.parse({ bringing, needed });
                const contribution = new IntentContribution(parsed);
                commitment.addContribution(contribution);
                
                // Update stats
                app.userStats.activitiesCreated++;
                app.userStats.contributionsMade++;
                app.saveUserStats();
                
                // Generate vouchers invisibly
                app.voucherEngine.generateVouchers(contribution);
            }

            app.commitments.set(commitment.id, commitment);
            app.saveData();
            
            // Clear form
            document.getElementById('create-prompt-text').value = '';
            document.getElementById('create-prompt-location').value = '';
            document.getElementById('create-prompt-threshold').value = '3';
            
            app.showSuccessAnimation('🎉');
            
            setTimeout(() => {
                alert('Activity created! 🎉\nIt\'s now available for others to discover.');
                showMainScreen();
                app.updateProfile();
            }, 500);
        }

        function showProfile() {
            showMainScreen();
            document.getElementById('profile-screen').classList.add('active');
            app.updateProfile();
        }

        // Request notification permission
        if ('Notification' in window && Notification.permission === 'default') {
            Notification.requestPermission();
        }

        // Start the app
        console.log('🎬 Creating app instance...');
        const app = new CrowdsurfingApp();
        console.log('🎊 App v2.0 started!', app);
    </script>
</body>
</html>
