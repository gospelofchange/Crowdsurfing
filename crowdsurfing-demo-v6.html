<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Crowdsurfing - Integrated Ecosystem</title>
<style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: white;
            overflow: hidden;
            touch-action: manipulation;
            position: relative;
        }

        /* System Status Indicator */
        .system-status {
            position: fixed;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 11px;
            z-index: 9999;
            backdrop-filter: blur(10px);
        }

        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 6px;
        }

        .status-online { background: #4CAF50; }
        .status-offline { background: #f44336; }
        .status-degraded { background: #ff9800; }

        /* Test Results (keeping from TDD version) */
        .test-results {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 10px;
            max-width: 250px;
            max-height: 150px;
            overflow-y: auto;
            z-index: 9999;
            backdrop-filter: blur(10px);
        }

        .test-pass { color: #4CAF50; }
        .test-fail { color: #f44336; }
        
        .screen {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: none;
            flex-direction: column;
            z-index: 100;
        }
        
        .screen.active {
            display: flex;
        }

        #main-screen.active {
            display: block;
        }
        
        .screen-header {
            display: flex;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            position: relative;
        }
        
        .back-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            backdrop-filter: blur(10px);
        }
        
        .back-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.05);
        }
        
        .screen-title {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            font-size: 20px;
            font-weight: bold;
        }
        
        .screen-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            padding-bottom: 100px;
        }
        
        .container {
            height: 100vh;
            display: flex;
            flex-direction: column;
            padding: 20px 20px 100px 20px;
            max-width: 400px;
            margin: 0 auto;
            position: relative;
        }
        
        .header {
            text-align: center;
            margin-bottom: 20px;
            z-index: 10;
        }
        
        .title {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 8px;
        }
        
        .subtitle {
            font-size: 14px;
            opacity: 0.9;
        }
        
        .card-container {
            flex: 1;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            perspective: 1000px;
        }
        
        .prompt-card {
            width: 100%;
            max-width: 350px;
            height: 450px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(15px);
            border-radius: 25px;
            padding: 25px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            position: absolute;
            cursor: grab;
            transition: transform 0.3s ease, opacity 0.3s ease;
            display: flex;
            flex-direction: column;
            user-select: none;
            touch-action: none;
        }
        
        .prompt-card:active {
            cursor: grabbing;
        }
        
        .prompt-card.swiping {
            transition: none;
        }
        
        .prompt-card.swipe-right {
            transform: translateX(100%) rotate(15deg);
            opacity: 0;
        }
        
        .prompt-card.swipe-left {
            transform: translateX(-100%) rotate(-15deg);
            opacity: 0;
        }

        .prompt-card.recommended {
            border-color: #4CAF50;
            box-shadow: 0 0 20px rgba(76, 175, 80, 0.3);
        }
        
        .prompt-text {
            font-size: 20px;
            line-height: 1.4;
            text-align: center;
            margin-bottom: 20px;
            font-weight: 500;
        }
        
        .swipe-icons {
            display: flex;
            justify-content: center;
            gap: 40px;
            margin-bottom: 15px;
        }
        
        .swipe-icon {
            font-size: 40px;
            font-weight: bold;
            opacity: 0;
            transition: opacity 0.2s ease, transform 0.2s ease;
            transform: scale(0.8);
        }
        
        .swipe-icon.left {
            color: #ff6b6b;
        }
        
        .swipe-icon.right {
            color: #4CAF50;
        }
        
        .swipe-icon.show {
            opacity: 0.9;
            transform: scale(1.1);
        }

        .recommendation-reasons {
            background: rgba(76, 175, 80, 0.2);
            padding: 8px 12px;
            border-radius: 12px;
            font-size: 12px;
            margin-bottom: 15px;
            text-align: center;
        }

        .recommendation-reasons .reason {
            display: block;
            margin: 2px 0;
        }
        
        .prompt-details {
            margin-top: auto;
        }

        .system-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            font-size: 11px;
            opacity: 0.7;
        }

        .system-badge {
            background: rgba(255, 255, 255, 0.1);
            padding: 3px 8px;
            border-radius: 8px;
            font-size: 10px;
        }

        .grassroots-badge { background: rgba(76, 175, 80, 0.3); }
        .holons-badge { background: rgba(255, 152, 0, 0.3); }
        .free-assoc-badge { background: rgba(156, 39, 176, 0.3); }
        
        .location-info {
            text-align: center;
            font-size: 16px;
            margin-bottom: 15px;
            opacity: 0.9;
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
        }
        
        .pool-status {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 12px;
            margin-bottom: 15px;
        }
        
        .pool-count {
            background: rgba(255, 255, 255, 0.2);
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 14px;
        }

        .offer-indicator {
            background: rgba(255, 152, 0, 0.3);
            padding: 6px 12px;
            border-radius: 12px;
            font-size: 12px;
            text-align: center;
            margin-bottom: 10px;
        }
        
        .decay-bar {
            height: 4px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 2px;
            overflow: hidden;
            margin-bottom: 10px;
        }
        
        .decay-progress {
            height: 100%;
            background: linear-gradient(90deg, #ff6b6b, #feca57, #48dbfb);
            transition: width 1s ease;
        }

        .value-display {
            text-align: center;
            font-size: 11px;
            opacity: 0.6;
            margin-bottom: 10px;
        }
        
        .controls {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-top: 20px;
            z-index: 10;
            margin-bottom: 80px;
        }
        
        .control-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: none;
            font-size: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s ease;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            backdrop-filter: blur(10px);
        }
        
        .control-btn:hover {
            transform: scale(1.1);
        }
        
        .control-btn:active {
            transform: scale(0.95);
        }
        
        .control-btn.reject {
            background: rgba(255, 107, 107, 0.3);
        }
        
        .control-btn.accept {
            background: rgba(76, 175, 80, 0.3);
        }
        
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(20px);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            padding: 12px 0 max(12px, env(safe-area-inset-bottom));
            z-index: 1000;
        }
        
        .nav-container {
            display: flex;
            justify-content: space-around;
            align-items: center;
            max-width: 400px;
            margin: 0 auto;
            padding: 0 20px;
        }
        
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
            padding: 8px;
            border-radius: 12px;
            min-width: 45px;
            position: relative;
        }
        
        .nav-item:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateY(-2px);
        }
        
        .nav-item.active {
            background: rgba(102, 126, 234, 0.3);
            border: 1px solid rgba(102, 126, 234, 0.5);
        }
        
        .nav-icon {
            font-size: 18px;
            opacity: 0.7;
            transition: opacity 0.2s ease;
        }
        
        .nav-item:hover .nav-icon,
        .nav-item.active .nav-icon {
            opacity: 1;
        }
        
        .nav-label {
            font-size: 9px;
            opacity: 0.6;
            font-weight: 500;
            transition: opacity 0.2s ease;
        }
        
        .nav-item:hover .nav-label,
        .nav-item.active .nav-label {
            opacity: 0.9;
        }

        .notification-badge {
            position: absolute;
            top: 4px;
            right: 4px;
            background: #f44336;
            color: white;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .no-more-cards {
            text-align: center;
            opacity: 0.7;
            margin-top: 50px;
        }
        
        .refresh-btn {
            margin-top: 20px;
            padding: 12px 24px;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 20px;
            color: white;
            cursor: pointer;
            backdrop-filter: blur(10px);
        }

        .trigger-message {
            background: #4CAF50;
            padding: 12px 20px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
            text-align: center;
            margin-top: 10px;
            animation: bounce 1s infinite;
        }
        
        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-5px); }
            60% { transform: translateY(-3px); }
        }

        /* Profile Screen Styles */
        .profile-info {
            text-align: center;
            margin-bottom: 25px;
        }
        
        .profile-avatar {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50%;
            margin: 0 auto 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            font-weight: bold;
        }
        
        .profile-id {
            opacity: 0.6;
            font-size: 12px;
            margin-bottom: 15px;
        }
        
        .profile-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 25px;
        }
        
        .stat-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 12px;
            border-radius: 10px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 4px;
        }
        
        .stat-label {
            font-size: 11px;
            opacity: 0.6;
        }

        /* Capacity Management */
        .capacity-section {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
        }

        .capacity-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .capacity-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .proficiency-bar {
            width: 60px;
            height: 4px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 2px;
            overflow: hidden;
        }

        .proficiency-fill {
            height: 100%;
            background: linear-gradient(90deg, #ff6b6b, #feca57, #48dbfb);
            transition: width 0.3s ease;
        }

        /* Modal Styles */
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            z-index: 2000;
            display: none;
            align-items: center;
            justify-content: center;
        }
        
        .overlay.show {
            display: flex;
        }
        
        .overlay-content {
            background: rgba(15, 23, 42, 0.95);
            border-radius: 20px;
            padding: 30px;
            max-width: 350px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            border: 1px solid rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(15px);
            position: relative;
        }
        
        .close-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            font-size: 24px;
            color: white;
            cursor: pointer;
            opacity: 0.6;
            transition: opacity 0.2s ease;
        }
        
        .close-btn:hover {
            opacity: 1;
        }

        /* Form Styles */
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
        }
        
        .form-input, .form-textarea, .form-select {
            width: 100%;
            padding: 12px 16px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            color: white;
            font-size: 14px;
            box-sizing: border-box;
        }
        
        .form-input::placeholder, .form-textarea::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }
        
        .form-textarea {
            min-height: 80px;
            resize: vertical;
        }

        .form-button {
            padding: 12px 24px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 12px;
            color: white;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s ease;
        }
        
        .form-button:hover {
            transform: translateY(-2px);
        }

        .form-button.secondary {
            background: rgba(255, 255, 255, 0.1);
            margin-right: 10px;
        }

        /* Search and Filter Styles */
        .search-container {
            margin-bottom: 20px;
        }
        
        .search-input {
            width: 100%;
            padding: 12px 16px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            color: white;
            font-size: 14px;
            margin-bottom: 15px;
            box-sizing: border-box;
        }
        
        .search-input::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }
        
        .search-results {
            max-height: 300px;
            overflow-y: auto;
        }
        
        .search-result {
            background: rgba(255, 255, 255, 0.05);
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: background 0.2s ease;
        }
        
        .search-result:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        
        .result-text {
            font-size: 14px;
            margin-bottom: 4px;
        }
        
        .result-meta {
            font-size: 11px;
            opacity: 0.6;
        }

        .filter-btn {
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            color: white;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .filter-btn:hover,
        .filter-btn.active {
            background: rgba(102, 126, 234, 0.3);
            border-color: rgba(102, 126, 234, 0.5);
        }

        .location-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .location-name {
            font-weight: 500;
        }
        
        .location-count {
            background: rgba(102, 126, 234, 0.3);
            padding: 4px 12px;
            border-radius: 16px;
            font-size: 12px;
        }

        .telegram-list {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .telegram-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
            border-left: 3px solid transparent;
        }
        
        .telegram-item:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateX(5px);
        }
        
        .telegram-item.active {
            border-left-color: #22c55e;
            background: rgba(34, 197, 94, 0.1);
        }
        
        .telegram-title {
            font-weight: 500;
            margin-bottom: 4px;
            font-size: 14px;
        }
        
        .telegram-meta {
            font-size: 11px;
            opacity: 0.6;
        }

        .no-chats {
            text-align: center;
            opacity: 0.5;
            padding: 40px 20px;
        }

        /* Star Rating Styles */
        .star-rating {
            transition: all 0.2s ease;
        }

        .star-rating:hover {
            transform: scale(1.1);
            filter: brightness(1.2);
        }

        .skill-endorse {
            transition: all 0.2s ease;
        }

        .skill-endorse:hover {
            transform: translateY(-1px);
        }

        .skill-endorse.active {
            background: rgba(76, 175, 80, 0.3) !important;
            border-color: rgba(76, 175, 80, 0.5) !important;
        }

        /* Enhanced recommendation badge */
        .recommendation-reasons {
            background: linear-gradient(135deg, rgba(76, 175, 80, 0.2), rgba(76, 175, 80, 0.1));
            border: 1px solid rgba(76, 175, 80, 0.3);
        }

        .system-badge {
            font-weight: 500;
            letter-spacing: 0.5px;
        }

        /* Reputation indicators */
        .reputation-high {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.3), rgba(255, 215, 0, 0.1));
            border: 1px solid rgba(255, 215, 0, 0.4);
        }

        .endorsement-badge {
            background: rgba(76, 175, 80, 0.2);
            border: 1px solid rgba(76, 175, 80, 0.3);
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 8px;
            margin-left: 6px;
        }
    

.entry-tags {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  margin-top: 10px;
}

.entry-tag {
  background: rgba(255, 255, 255, 0.1);
  padding: 6px 10px;
  border-radius: 12px;
  font-size: 13px;
  display: flex;
  align-items: center;
}

.entry-tag .remove-tag {
  margin-left: 8px;
  cursor: pointer;
  font-weight: bold;
  opacity: 0.7;
}
.entry-tag .remove-tag:hover {
  opacity: 1;
}

</style>
</head>
<body>
<!-- System Status Indicator -->
<div class="system-status" id="system-status">
<div><span class="status-indicator status-online"></span> Grassroots: Online</div>
<div><span class="status-indicator status-online"></span> Free Assoc: Online</div>
<div><span class="status-indicator status-offline"></span> Holons: Offline</div>
<div><span class="status-indicator status-online"></span> Telegram: Online</div>
</div>
<!-- Test Results Display -->
<div class="test-results" id="test-results"></div>
<!-- Main Screen (Prompt Cards) -->
<div class="screen active" id="main-screen">
<div class="container">
<div class="header">
<div class="title">Crowdsurfing</div>
<div class="subtitle">Swipe right to join commitments ‚û°Ô∏è</div>
</div>
<div class="card-container" id="card-container">
</div>
<div class="controls">
<button class="control-btn reject" onclick="ui.handleReject()">‚úó</button>
<button class="control-btn accept" onclick="ui.handleAccept()">‚úì</button>
</div>
</div>
</div>
<!-- Profile Screen -->
<div class="screen" id="profile-screen">
<div class="screen-header">
<button class="back-btn" onclick="ui.showMainScreen()">‚Üê</button>
<div class="screen-title">Profile</div>
</div>
<div class="screen-content">
<div class="profile-info">
<div class="profile-avatar" id="profile-avatar">?</div>
<div class="profile-id" id="profile-id">Loading...</div>
</div>
<div class="profile-stats">
<div class="stat-item">
<div class="stat-value" id="total-swipes">0</div>
<div class="stat-label">Total Swipes</div>
</div>
<div class="stat-item">
<div class="stat-value" id="groups-joined">0</div>
<div class="stat-label">Groups Joined</div>
</div>
<div class="stat-item">
<div class="stat-value" id="prompts-created">0</div>
<div class="stat-label">Created</div>
</div>
<div class="stat-item">
<div class="stat-value" id="reputation-score">1.0</div>
<div class="stat-label">Reputation</div>
</div>
</div>
<!-- Capacity Management -->
<div class="capacity-section">
<div class="capacity-header">
<h3>My Skills &amp; Offerings</h3>
<button class="form-button" onclick="ui.showAddSkillModal()">+ Add</button>
</div>
<div id="skills-list">
<!-- Will be populated dynamically -->
</div>
</div>
<div class="capacity-section">
<div class="capacity-header">
<h3>Learning Interests</h3>
<button class="form-button" onclick="ui.showAddInterestModal()">+ Add</button>
</div>
<div id="interests-list">
<!-- Will be populated dynamically -->
</div>
</div>
<!-- Reputation & Recognition -->
<div class="capacity-section">
<div class="capacity-header">
<h3>Reputation &amp; Recognition</h3>
</div>
<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
<div class="stat-item">
<div class="stat-value" id="holons-rating">0.0</div>
<div class="stat-label">Holons Rating</div>
</div>
<div class="stat-item">
<div class="stat-value" id="endorsements-count">0</div>
<div class="stat-label">Skill Endorsements</div>
</div>
<div class="stat-item">
<div class="stat-value" id="trust-network">0</div>
<div class="stat-label">Trust Network</div>
</div>
<div class="stat-item">
<div class="stat-value" id="reliability-score">100%</div>
<div class="stat-label">Reliability</div>
</div>
</div>
<div id="recent-appreciations">
<!-- Will show recent appreciations received -->
</div>
</div>
<!-- Location & Preferences -->
<div class="capacity-section">
<div class="capacity-header">
<h3>Location &amp; Preferences</h3>
<button class="form-button" onclick="ui.showLocationModal()">Edit</button>
</div>
<div class="capacity-item">
<div>
<div style="font-weight: 500;">Current Location</div>
<div id="current-location" style="font-size: 12px; opacity: 0.7;">Mauerpark, Berlin</div>
</div>
<div id="mobility-range" style="font-size: 12px; opacity: 0.8;">High mobility</div>
</div>
<div class="capacity-item">
<div>
<div style="font-weight: 500;">Group Size Preference</div>
<div id="group-preference" style="font-size: 12px; opacity: 0.7;">Medium groups (3-6 people)</div>
</div>
</div>
</div>
</div>
</div>
<!-- Create Screen -->
<div class="screen" id="create-screen">
<div class="screen-header">
<button class="back-btn" onclick="ui.showMainScreen()">‚Üê</button>
<div class="screen-title">Create Commitment</div>
</div>
<div class="screen-content">
<div class="form-group">
<label class="form-label">What do you want to do together?</label>
<textarea class="form-textarea" id="commitment-text" placeholder="e.g., Want to jam with instruments and share musical stories üéµ"></textarea>
</div>
<div class="form-group">
<label class="form-label">Where should people meet?</label>
<input class="form-input" id="commitment-location" placeholder="e.g., By the fountain in Mauerpark" type="text"/>
</div>
<div class="form-group">
<label class="form-label">How many people needed?</label>
<input class="form-input" id="commitment-threshold" max="20" min="2" type="number" value="3"/>
</div>
<div class="form-group">
<label class="form-label">Activity duration</label>
<select class="form-input" id="activity-duration">
<option value="30 minutes">30 minutes</option>
<option selected="" value="1 hour">1 hour</option>
<option value="2 hours">2 hours</option>
<option value="Half day">Half day</option>
<option value="Open-ended">Open-ended</option>
</select>
</div>
<div class="form-group">
<label class="form-label">Demurrage rate (% per day)</label>
<input class="form-input" id="demurrage-rate" max="50" min="0.1" step="0.1" type="number" value="2.0"/>
<div style="font-size: 12px; opacity: 0.7; margin-top: 5px;">
                    Higher rates mean faster decay - encourages quicker action
                </div>
</div>
<button class="form-button" onclick="ui.createCommitment()" style="width: 100%; margin-top: 20px;">
                Create Commitment ‚ú®
            </button>
</div>
</div>
<!-- Chats Screen -->
<div class="screen" id="chats-screen">
<div class="screen-header">
<button class="back-btn" onclick="ui.showMainScreen()">‚Üê</button>
<div class="screen-title">Your Chats</div>
</div>
<div class="screen-content">
<!-- Notifications Section -->
<div style="margin-bottom: 25px;">
<h3 style="margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
<span>üîî</span> Recent Activity
                </h3>
<div id="recent-notifications">
<!-- Will be populated with recent notifications -->
</div>
</div>
<!-- Telegram Groups Section -->
<div style="margin-bottom: 20px;">
<h3 style="margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
<span>üì±</span> Telegram Groups
                </h3>
<div id="telegram-groups-list">
<div class="no-chats">
<div style="font-size: 40px; margin-bottom: 10px;">üí¨</div>
<div>No active chats yet</div>
<div style="font-size: 12px; margin-top: 5px;">Join a group by swiping right on prompts!</div>
</div>
</div>
</div>
</div>
</div>
<!-- Map Screen -->
<div class="screen" id="map-screen">
<div class="screen-header">
<button class="back-btn" onclick="ui.showMainScreen()">‚Üê</button>
<div class="screen-title">Map View</div>
</div>
<div class="screen-content">
<div style="background: rgba(255, 255, 255, 0.1); border-radius: 20px; padding: 40px; text-align: center; height: 400px; display: flex; align-items: center; justify-content: center; flex-direction: column;">
<div style="font-size: 48px; margin-bottom: 20px;">üó∫Ô∏è</div>
<h3>Geographic View</h3>
<p style="opacity: 0.7; margin: 15px 0;">See all prompts distributed across locations</p>
<div id="map-stats" style="margin-top: 20px; font-size: 14px; opacity: 0.8;">
                    Loading map data...
                </div>
</div>
<div style="margin-top: 20px;">
<h3 style="margin-bottom: 15px;">Active Locations</h3>
<div id="location-list">
<!-- Will be populated with location data -->
</div>
</div>
</div>
</div>
<!-- Search Screen -->
<div class="screen" id="search-screen">
<div class="screen-header">
<button class="back-btn" onclick="ui.showMainScreen()">‚Üê</button>
<div class="screen-title">Search</div>
</div>
<div class="screen-content">
<div class="search-container">
<input class="search-input" id="search-input-screen" oninput="ui.performSearchScreen()" placeholder="Search for activities, locations, or keywords..." type="text"/>
<div style="margin: 20px 0;">
<h3 style="margin-bottom: 15px;">Quick Filters</h3>
<div style="display: flex; flex-wrap: wrap; gap: 10px;">
<button class="filter-btn" onclick="ui.filterByCategory('music')">üéµ Music</button>
<button class="filter-btn" onclick="ui.filterByCategory('food')">üçï Food</button>
<button class="filter-btn" onclick="ui.filterByCategory('discussion')">üí¨ Discussion</button>
<button class="filter-btn" onclick="ui.filterByCategory('learning')">üìö Learning</button>
<button class="filter-btn" onclick="ui.filterByCategory('active')">‚ö° Active</button>
<button class="filter-btn" onclick="ui.filterByCategory('all')">üåä All</button>
</div>
</div>
<div class="search-results" id="search-results-screen">
<div class="no-chats">Start typing or use filters to find prompts...</div>
</div>
</div>
</div>
</div>
<!-- Bottom Navigation -->
<div class="bottom-nav">
<div class="nav-container">
<div class="nav-item" onclick="ui.showProfile()">
<div class="nav-icon">üë§</div>
<div class="nav-label">Profile</div>
</div>
<div class="nav-item" onclick="ui.showCreatePrompt()">
<div class="nav-icon">üí°</div>
<div class="nav-label">Create</div>
</div>
<div class="nav-item" onclick="ui.showTelegramChats()">
<div class="nav-icon">üí¨</div>
<div class="nav-label">Chats</div>
<div class="notification-badge" id="notification-badge" style="display: none;">0</div>
</div>
<div class="nav-item" id="map-nav" onclick="ui.toggleMapView()">
<div class="nav-icon">üó∫Ô∏è</div>
<div class="nav-label">Map</div>
</div>
<div class="nav-item" onclick="ui.showSearch()">
<div class="nav-icon">üîç</div>
<div class="nav-label">Search</div>
</div>
</div>
</div>

<!-- Intent Contribution Screen -->
<div class="screen" id="intent-screen">
<div class="screen-header">
<button class="back-btn" onclick="ui.showCreatePrompt()">‚Üê</button>
<div class="screen-title">Offer &amp; Request Contributions</div>
</div>
<div class="screen-content">
<!-- I'm bringing -->
<div class="form-group">
<label class="form-label">I‚Äôm bringing‚Ä¶</label>
<div class="multi-entry-container" id="bring-container">
<input class="form-input" id="bring-input" onkeydown="ui.handleMultiEntry(event, 'bring')" placeholder="e.g., üé§ Speaker, ü•Å Drum, üéôÔ∏è Recording skills" type="text"/>
<div class="entry-tags" id="bring-tags"></div>
</div>
<div style="font-size: 12px; opacity: 0.6; margin-top: 6px;">
        Each offering supports the group and adds value to the shared pool.
      </div>
</div>
<!-- It would be great if we had -->
<div class="form-group">
<label class="form-label">It would be great if we had‚Ä¶</label>
<div class="multi-entry-container" id="wish-container">
<input class="form-input" id="wish-input" onkeydown="ui.handleMultiEntry(event, 'wish')" placeholder="e.g., üßò Quiet space, üé¨ Projector, ‚òï Tea for everyone" type="text"/>
<div class="entry-tags" id="wish-tags"></div>
</div>
<div style="font-size: 12px; opacity: 0.6; margin-top: 6px;">
        These stretch goals inspire others to fill the gaps with their gifts.
      </div>
</div>
<button class="form-button" onclick="ui.submitIntentContributions()" style="width: 100%; margin-top: 20px;">
      Submit Intentions üí´
    </button>
</div>
</div>
<script>
window.AppState = typeof AppState !== 'undefined' ? AppState : function AppState() {
  this.user = { userId: "user_" + Math.random().toString(36).substr(2, 8) };
  this.commitments = new Map();
  this.updateState = function(event, payload) {
    console.log("üåê AppState updated:", event, payload);
  };
};

window.IntegratedCommitment = typeof IntegratedCommitment !== 'undefined' ? IntegratedCommitment : function(id, text, location, threshold, demurrageRate, userId) {
  this.id = id;
  this.text = text;
  this.location = location;
  this.threshold = threshold;
  this.demurrageRate = demurrageRate;
  this.userId = userId;
  this.timestamp = Date.now();
};

if (typeof appState === 'undefined') {
  window.appState = new AppState();
}
if (typeof ui === 'undefined') {
  window.ui = {};
}


// Ensure global app state exists before UI logic uses it
if (typeof appState === 'undefined') {
  var appState = new AppState();
}


        // ====================
        // INTEGRATED SYSTEM MODELS
        // ====================

        /**
         * Enhanced Commitment with all integrations
         */
        class IntegratedCommitment {
            constructor(id, text, location, threshold, demurrageRate = 0.02, creator = null) {
                this.id = id;
                this.text = text;
                this.location = location;
                this.threshold = threshold;
                this.demurrageRate = demurrageRate;
                this.creator = creator;
                this.createdAt = Date.now();
                this.swipes = [];
                this.triggered = false;
                this.expired = false;
                this.activityDuration = '1 hour';
                
                // Grassroots Economics integration
                this.voucherValue = 100;
                this.grassrootsAddress = null;
                
                // Holons integration
                this.offers = [];
                this.holonsId = null;
                
                // Free Association integration
                this.requiredSkills = [];
                this.recommendedFor = [];
                
                // Telegram integration
                this.telegramGroupId = null;
                this.telegramInviteLink = null;
            }

            getCurrentValue() {
                const ageInDays = (Date.now() - this.createdAt) / (1000 * 60 * 60 * 24);
                return Math.exp(-this.demurrageRate * ageInDays);
            }

            getCurrentVoucherValue() {
                return this.voucherValue * this.getCurrentValue();
            }

            isExpired() {
                return this.getCurrentValue() < 0.01 || this.expired;
            }

            addCapacity(userId) {
                if (!this.swipes.includes(userId) && !this.isExpired()) {
                    this.swipes.push(userId);
                    
                    if (this.swipes.length >= this.threshold && !this.triggered) {
                        this.triggered = true;
                        return true;
                    }
                }
                return false;
            }

            extractSkills() {
                const skillMap = {
                    'music': ['music', 'jam', 'instrument', 'song', 'band', 'guitar', 'piano'],
                    'discussion': ['discuss', 'talk', 'philosophy', 'debate', 'conversation'],
                    'food': ['food', 'cook', 'eat', 'recipe', 'meal', 'potluck'],
                    'learning': ['learn', 'teach', 'skill', 'knowledge', 'share'],
                    'art': ['art', 'create', 'draw', 'paint', 'craft', 'make'],
                    'movement': ['walk', 'dance', 'exercise', 'yoga', 'sport'],
                    'nature': ['nature', 'garden', 'plants', 'outdoor', 'environment']
                };

                const textLower = this.text.toLowerCase();
                const skills = [];

                Object.entries(skillMap).forEach(([skill, keywords]) => {
                    if (keywords.some(keyword => textLower.includes(keyword))) {
                        skills.push(skill);
                    }
                });

                return skills;
            }

            toJSON() {
                return {
                    id: this.id,
                    text: this.text,
                    location: this.location,
                    threshold: this.threshold,
                    demurrageRate: this.demurrageRate,
                    creator: this.creator,
                    createdAt: this.createdAt,
                    swipes: this.swipes,
                    triggered: this.triggered,
                    expired: this.expired,
                    activityDuration: this.activityDuration,
                    voucherValue: this.voucherValue,
                    grassrootsAddress: this.grassrootsAddress,
                    offers: this.offers,
                    holonsId: this.holonsId,
                    requiredSkills: this.requiredSkills,
                    recommendedFor: this.recommendedFor,
                    telegramGroupId: this.telegramGroupId,
                    telegramInviteLink: this.telegramInviteLink
                };
            }

            static fromJSON(data) {
                const commitment = new IntegratedCommitment(
                    data.id, data.text, data.location, data.threshold,
                    data.demurrageRate || 0.02, data.creator
                );
                
                Object.assign(commitment, data);
                return commitment;
            }
        }

        /**
         * Enhanced Capacity with Reputation and Recognition
         */
        class EnhancedCapacity {
            constructor(userId) {
                this.userId = userId;
                this.offerings = new Map();
                this.requests = new Map();
                this.affinities = new Map();
                this.reputation = 1.0;
                this.commitments = new Set();
                
                // Enhanced reputation system
                this.holonsAppreciation = {
                    received: [], // Appreciation received from others
                    given: [], // Appreciation given to others
                    averageRating: 0,
                    totalActivities: 0,
                    reliabilityScore: 1.0 // Shows up rate for commitments
                };
                
                this.freeAssociationRecognition = {
                    skillEndorsements: new Map(), // Skills endorsed by others
                    endorsementsGiven: new Map(), // Skills we've endorsed in others
                    mutualConnections: new Set(), // People who recognize us mutually
                    trustNetwork: new Map() // Trust scores with specific people
                };
                
                // Location and preferences
                this.location = {
                    current: null,
                    preferred: [],
                    mobility: 1.0 // How far willing to travel (0-1)
                };
                
                this.preferences = {
                    groupSizePreference: 'medium', // small, medium, large
                    timePreferences: [],
                    activityTypes: new Map()
                };
            }

            addOffering(skill, proficiency = 0.5) {
                this.offerings.set(skill, {
                    proficiency: proficiency,
                    timesOffered: (this.offerings.get(skill)?.timesOffered || 0) + 1,
                    lastUpdated: Date.now(),
                    endorsements: 0 // How many people endorsed this skill
                });
            }

            addRequest(skill, urgency = 0.5) {
                this.requests.set(skill, {
                    urgency: urgency,
                    timesRequested: (this.requests.get(skill)?.timesRequested || 0) + 1,
                    lastUpdated: Date.now(),
                    progress: 0 // Learning progress (0-1)
                });
            }

            // Holons appreciation system
            receiveAppreciation(fromUserId, activity, rating, comment = '') {
                const appreciation = {
                    fromUserId,
                    activity,
                    rating, // 1-5 scale
                    comment,
                    timestamp: Date.now(),
                    activityType: this.categorizeActivity(activity)
                };
                
                this.holonsAppreciation.received.push(appreciation);
                this.updateHolonsReputation();
                
                // Update skill endorsements based on activity
                const skills = this.extractSkillsFromActivity(activity);
                skills.forEach(skill => {
                    if (this.offerings.has(skill)) {
                        this.offerings.get(skill).endorsements++;
                    }
                });
            }

            giveAppreciation(toUserId, activity, rating, comment = '') {
                const appreciation = {
                    toUserId,
                    activity,
                    rating,
                    comment,
                    timestamp: Date.now()
                };
                
                this.holonsAppreciation.given.push(appreciation);
                
                // Track that we've worked with this person
                this.addMutualConnection(toUserId);
            }

            // Free Association mutual recognition
            endorseSkill(userId, skill, strength = 1.0) {
                if (!this.freeAssociationRecognition.endorsementsGiven.has(userId)) {
                    this.freeAssociationRecognition.endorsementsGiven.set(userId, new Map());
                }
                
                this.freeAssociationRecognition.endorsementsGiven.get(userId).set(skill, {
                    strength,
                    timestamp: Date.now()
                });
                
                this.addMutualConnection(userId);
            }

            receiveSkillEndorsement(fromUserId, skill, strength = 1.0) {
                if (!this.freeAssociationRecognition.skillEndorsements.has(skill)) {
                    this.freeAssociationRecognition.skillEndorsements.set(skill, []);
                }
                
                (this.freeAssociationRecognition.skillEndorsements?.get || (() => undefined))(skill).push({
                    fromUserId,
                    strength,
                    timestamp: Date.now()
                });
                
                // Update offering proficiency based on endorsements
                if (this.offerings.has(skill)) {
                    const endorsements = (this.freeAssociationRecognition.skillEndorsements?.get || (() => undefined))(skill);
                    const avgEndorsement = endorsements.reduce((sum, e) => sum + e.strength, 0) / endorsements.length;
                    const currentProficiency = this.offerings.get(skill).proficiency;
                    
                    // Blend self-assessment with peer recognition
                    this.offerings.get(skill).proficiency = (currentProficiency + avgEndorsement) / 2;
                }
                
                this.addMutualConnection(fromUserId);
            }

            addMutualConnection(userId) {
                this.freeAssociationRecognition.mutualConnections.add(userId);
                
                // Update trust score
                const currentTrust = this.freeAssociationRecognition.trustNetwork.get(userId) || 0;
                this.freeAssociationRecognition.trustNetwork.set(userId, Math.min(1.0, currentTrust + 0.1));
            }

            updateHolonsReputation() {
                const received = this.holonsAppreciation.received;
                if (received.length === 0) return;
                
                // Calculate average rating
                const totalRating = received.reduce((sum, app) => sum + app.rating, 0);
                this.holonsAppreciation.averageRating = totalRating / received.length;
                
                // Calculate reliability (showing up for commitments)
                const recentActivities = received.filter(app => 
                    Date.now() - app.timestamp < 30 * 24 * 60 * 60 * 1000 // Last 30 days
                );
                
                if (recentActivities.length > 0) {
                    const reliabilityScore = recentActivities.reduce((sum, app) => 
                        sum + (app.rating >= 4 ? 1 : 0.5), 0) / recentActivities.length;
                    this.holonsAppreciation.reliabilityScore = reliabilityScore;
                }
                
                // Update overall reputation
                this.reputation = this.calculateCompositeReputation();
            }

            calculateCompositeReputation() {
                // Combine Holons and Free Association scores
                const holonsScore = (this.holonsAppreciation.averageRating / 5) * 
                                   this.holonsAppreciation.reliabilityScore;
                
                const endorsementScore = this.calculateEndorsementScore();
                const networkScore = this.freeAssociationRecognition.mutualConnections.size / 10; // Normalize
                
                // Weighted combination
                return Math.min(2.0, 
                    (holonsScore * 0.4) + 
                    (endorsementScore * 0.3) + 
                    (Math.min(1.0, networkScore) * 0.2) + 
                    (0.5 * 0.1) // Base score
                );
            }

            calculateEndorsementScore() {
                let totalEndorsements = 0;
                let weightedSum = 0;
                
                this.freeAssociationRecognition.skillEndorsements.forEach((endorsements, skill) => {
                    endorsements.forEach(endorsement => {
                        totalEndorsements++;
                        weightedSum += endorsement.strength;
                    });
                });
                
                return totalEndorsements > 0 ? weightedSum / totalEndorsements : 0.5;
            }

            // Enhanced compatibility calculation with reputation and location
            calculateCompatibility(commitment, userLocation = null) {
                let score = 0;
                const commitmentSkills = commitment.extractSkills();

                // Skill compatibility (40%)
                commitmentSkills.forEach(skill => {
                    if (this.offerings.has(skill)) {
                        const offering = this.offerings.get(skill);
                        score += offering.proficiency * 0.3;
                        
                        // Bonus for endorsed skills
                        const endorsements = (this.freeAssociationRecognition.skillEndorsements?.get || (() => undefined))(skill);
                        if (endorsements && endorsements.length > 0) {
                            score += 0.1;
                        }
                    }
                    if (this.requests.has(skill)) {
                        score += this.requests.get(skill).urgency * 0.1;
                    }
                });

                // Reputation boost (20%)
                const reputationBonus = (this.reputation - 1.0) * 0.2; // -0.2 to +0.2
                score += reputationBonus;

                // Location compatibility (15%)
                if (userLocation && commitment.location) {
                    const locationScore = this.calculateLocationCompatibility(commitment.location, userLocation);
                    score += locationScore * 0.15;
                }

                // Social connection bonus (10%)
                const socialBonus = this.calculateSocialConnectionBonus(commitment);
                score += socialBonus * 0.1;

                // Group size preference (10%)
                const groupSizeBonus = this.calculateGroupSizeBonus(commitment);
                score += groupSizeBonus * 0.1;

                // Time preference (5%)
                const timeBonus = this.calculateTimeBonus(commitment);
                score += timeBonus * 0.05;

                return Math.min(score, 1.0);
            }

            calculateLocationCompatibility(commitmentLocation, userLocation) {
                // Simple string matching for now - could be enhanced with real coordinates
                if (commitmentLocation.toLowerCase() === userLocation.toLowerCase()) {
                    return 1.0;
                }
                
                // Check for partial matches
                const commitmentWords = commitmentLocation.toLowerCase().split(' ');
                const userWords = userLocation.toLowerCase().split(' ');
                
                const commonWords = commitmentWords.filter(word => 
                    userWords.some(userWord => userWord.includes(word) || word.includes(userWord))
                );
                
                const similarity = commonWords.length / Math.max(commitmentWords.length, userWords.length);
                return similarity * this.location.mobility;
            }

            calculateSocialConnectionBonus(commitment) {
                // Check if people we trust have swiped on this commitment
                const trustedParticipants = commitment.swipes.filter(userId => 
                    this.freeAssociationRecognition.mutualConnections.has(userId)
                );
                
                return Math.min(0.5, trustedParticipants.length * 0.2);
            }

            calculateGroupSizeBonus(commitment) {
                const size = commitment.threshold;
                const preference = this.preferences.groupSizePreference;
                
                if (preference === 'small' && size <= 3) return 1.0;
                if (preference === 'medium' && size >= 3 && size <= 6) return 1.0;
                if (preference === 'large' && size > 6) return 1.0;
                
                return 0.5; // Neutral if not preferred size
            }

            calculateTimeBonus(commitment) {
                // Simple implementation - could be enhanced with actual time preferences
                return 0.5;
            }

            getRecommendationReasons(commitment) {
                const reasons = [];
                const skills = commitment.extractSkills();

                skills.forEach(skill => {
                    if (this.offerings.has(skill)) {
                        const offering = this.offerings.get(skill);
                        const endorsements = (this.freeAssociationRecognition.skillEndorsements?.get || (() => undefined))(skill);
                        
                        if (endorsements && endorsements.length > 0) {
                            reasons.push(`${endorsements.length} people endorsed your ${skill} skills`);
                        } else if (offering.proficiency > 0.7) {
                            reasons.push(`Expert in ${skill}`);
                        } else if (offering.proficiency > 0.5) {
                            reasons.push(`Good at ${skill}`);
                        }
                    }
                    if (this.requests.has(skill)) {
                        reasons.push(`Want to learn ${skill}`);
                    }
                });

                // Add reputation-based reasons
                if (this.reputation > 1.5) {
                    reasons.push('High community reputation');
                } else if (this.reputation > 1.2) {
                    reasons.push('Good community standing');
                }

                // Add social reasons
                const trustedParticipants = commitment.swipes.filter(userId => 
                    this.freeAssociationRecognition.mutualConnections.has(userId)
                );
                
                if (trustedParticipants.length > 0) {
                    reasons.push(`${trustedParticipants.length} trusted connection${trustedParticipants.length > 1 ? 's' : ''} interested`);
                }

                return reasons;
            }

            categorizeActivity(activity) {
                const text = activity.toLowerCase();
                if (text.includes('music') || text.includes('jam')) return 'music';
                if (text.includes('food') || text.includes('cook')) return 'food';
                if (text.includes('discuss') || text.includes('talk')) return 'discussion';
                if (text.includes('learn') || text.includes('teach')) return 'learning';
                return 'social';
            }

            extractSkillsFromActivity(activity) {
                // Reuse the skill extraction logic from commitments
                const skillMap = {
                    'music': ['music', 'jam', 'instrument', 'song'],
                    'discussion': ['discuss', 'talk', 'philosophy', 'debate'],
                    'food': ['food', 'cook', 'eat', 'recipe'],
                    'learning': ['learn', 'teach', 'skill', 'knowledge'],
                    'art': ['art', 'create', 'draw', 'paint'],
                    'movement': ['walk', 'dance', 'exercise', 'yoga']
                };

                const textLower = activity.toLowerCase();
                const skills = [];

                Object.entries(skillMap).forEach(([skill, keywords]) => {
                    if (keywords.some(keyword => textLower.includes(keyword))) {
                        skills.push(skill);
                    }
                });

                return skills;
            }
        }

        /**
         * Enhanced User Profile
         */
        class EnhancedUserProfile {
            constructor(userId) {
                this.userId = userId;
                this.createdAt = Date.now();
                this.capacity = new EnhancedCapacity(userId);
                this.stats = {
                    totalSwipes: 0,
                    rightSwipes: 0,
                    groupsJoined: 0,
                    promptsCreated: 0,
                    completedCommitments: 0
                };
                this.lastActive = Date.now();
                this.grassrootsAddress = null;
                this.telegramId = null;
            }

            updateStats(updates) {
                Object.assign(this.stats, updates);
                this.lastActive = Date.now();
            }

            getSuccessRate() {
                return this.stats.totalSwipes > 0 ? 
                    Math.round((this.stats.groupsJoined / this.stats.totalSwipes) * 100) : 0;
            }
        }

        // ====================
        // MOCK INTEGRATION SERVICES
        // ====================

        /**
         * Mock Grassroots Economics Service
         */
        class MockGrassrootsService {
            constructor() {
                this.connected = true;
            }

            async createVoucher(commitment) {
                console.log('üå± Creating Grassroots voucher for:', commitment.text);
                
                // Simulate API delay
                await new Promise(resolve => setTimeout(resolve, 500));
                
                return {
                    voucher_address: `0x${commitment.id.toString(16).padStart(40, '0')}`,
                    transaction_hash: `0x${Math.random().toString(16).substring(2)}`,
                    initial_value: commitment.voucherValue,
                    demurrage_rate: commitment.demurrageRate
                };
            }
        }

        /**
         * Mock Free Association Service
         */
        class MockFreeAssociationService {
            constructor() {
                this.connected = true;
            }

            async syncCapacity(capacity) {
                console.log('üîó Syncing capacity to Free Association:', capacity.userId);
                return { success: true };
            }

            async findRecommendations(userCapacity, commitments) {
                console.log('üéØ Finding recommendations via Free Association');
                
                return commitments.map(commitment => ({
                    commitment,
                    compatibility: userCapacity.calculateCompatibility(commitment),
                    reasons: userCapacity.getRecommendationReasons(commitment)
                })).filter(rec => rec.compatibility > 0.2)
                  .sort((a, b) => b.compatibility - a.compatibility);
            }
        }

        /**
         * Mock Holons Service
         */
        class MockHolonsService {
            constructor() {
                this.connected = false; // Simulating offline
            }

            async createOffer(commitment) {
                if (!this.connected) return null;
                
                console.log('ü§ù Creating Holons offer for:', commitment.text);
                return {
                    offer_id: `offer_${commitment.id}`,
                    offer_url: `https://holons.bot/offers/offer_${commitment.id}`
                };
            }
        }

        /**
         * Mock Telegram Service
         */
        class MockTelegramService {
            constructor() {
                this.connected = true;
                this.groups = new Map();
            }

            async createGroupChat(commitment, participants) {
                console.log('üì± Creating Telegram group for:', commitment.text);
                
                const groupData = {
                    chat_id: -100000000 - commitment.id,
                    title: `üåä ${commitment.text.substring(0, 40)}...`,
                    invite_link: `https://t.me/joinchat/${Math.random().toString(36).substring(2, 10)}`,
                    participants: participants,
                    created_at: Date.now()
                };
                
                this.groups.set(commitment.id, groupData);
                return groupData;
            }

            getGroupForCommitment(commitmentId) {
                return this.groups.get(commitmentId);
            }

            getAllGroups() {
                return Array.from(this.groups.values());
            }
        }

        // ====================
        // INTEGRATED APPLICATION SERVICE
        // ====================

        /**
         * Main application with all integrations
         */
        class IntegratedCrowdsurfingApp {
            constructor(storage = localStorage) {
                this.storage = storage;
                this.commitments = new Map();
                this.currentUser = null;
                this.userSwipes = new Set();
                this.currentIndex = 0;
                this.isAnimating = false;
                this.currentCard = null;
                this.notifications = [];

                // Integration services
                this.grassrootsService = new MockGrassrootsService();
                this.freeAssociationService = new MockFreeAssociationService();
                this.holonsService = new MockHolonsService();
                this.telegramService = new MockTelegramService();

                this.init();
            }

            async init() {
                this.loadUser();
                this.loadCommitments();
                this.loadUserSwipes();
                this.loadNotifications();
                this.updateSystemStatus();
                await this.initializeIntegrations();
                this.renderCurrentCard();
                this.startDemurrageTimer();
            }

            loadUser() {
                const userId = this.generateUserId();
                const saved = this.storage.getItem('user-profile');
                
                if (saved) {
                    const data = JSON.parse(saved);
                    this.currentUser = Object.assign(new EnhancedUserProfile(userId), data);
                    this.currentUser.capacity = Object.assign(new EnhancedCapacity(userId), data.capacity);
                    
                    // Restore Maps
                    if (data.capacity.offerings) {
                        this.currentUser.capacity.offerings = new Map(Object.entries(data.capacity.offerings));
                    }
                    if (data.capacity.requests) {
                        this.currentUser.capacity.requests = new Map(Object.entries(data.capacity.requests));
                    }
                } else {
                    this.currentUser = new EnhancedUserProfile(userId);
                    this.initializeUserCapacities();
                    this.saveUser();
                }
            }

            initializeUserCapacities() {
                // Add some sample skills for new users
                const sampleSkills = [
                    { skill: 'music', proficiency: 0.3 + Math.random() * 0.4 },
                    { skill: 'discussion', proficiency: 0.4 + Math.random() * 0.3 }
                ];

                sampleSkills.forEach(({ skill, proficiency }) => {
                    this.currentUser.capacity.addOffering(skill, proficiency);
                });

                // Add learning interests
                const interests = ['learning', 'art'];
                interests.forEach(interest => {
                    this.currentUser.capacity.addRequest(interest, 0.6 + Math.random() * 0.3);
                });

                // Set default location and preferences
                this.currentUser.capacity.location.current = 'Mauerpark, Berlin';
                this.currentUser.capacity.location.preferred = ['Mauerpark', 'Berlin'];
                this.currentUser.capacity.location.mobility = 0.8;
                
                this.currentUser.capacity.preferences.groupSizePreference = 'medium';

                // Add some sample appreciation and endorsements for demo
                this.addSampleReputationData();
            }

            addSampleReputationData() {
                const capacity = this.currentUser.capacity;
                
                // Add some sample appreciations received
                const sampleAppreciations = [
                    {
                        fromUserId: 'user_abc123',
                        activity: 'Music jam session in the park',
                        rating: 5,
                        comment: 'Amazing guitarist! Really brought the group together.',
                        timestamp: Date.now() - (2 * 24 * 60 * 60 * 1000), // 2 days ago
                        activityType: 'music'
                    },
                    {
                        fromUserId: 'user_def456',
                        activity: 'Philosophy discussion about AI ethics',
                        rating: 4,
                        comment: 'Thoughtful questions that deepened our conversation.',
                        timestamp: Date.now() - (5 * 24 * 60 * 60 * 1000), // 5 days ago
                        activityType: 'discussion'
                    }
                ];

                sampleAppreciations.forEach(appreciation => {
                    capacity.holonsAppreciation.received.push(appreciation);
                });

                // Add some skill endorsements
                if (capacity.offerings.has('music')) {
                    capacity.freeAssociationRecognition.skillEndorsements.set('music', [
                        { fromUserId: 'user_abc123', strength: 0.9, timestamp: Date.now() - (2 * 24 * 60 * 60 * 1000) },
                        { fromUserId: 'user_ghi789', strength: 0.8, timestamp: Date.now() - (7 * 24 * 60 * 60 * 1000) }
                    ]);
                }

                if (capacity.offerings.has('discussion')) {
                    capacity.freeAssociationRecognition.skillEndorsements.set('discussion', [
                        { fromUserId: 'user_def456', strength: 0.85, timestamp: Date.now() - (5 * 24 * 60 * 60 * 1000) }
                    ]);
                }

                // Add some mutual connections
                capacity.freeAssociationRecognition.mutualConnections.add('user_abc123');
                capacity.freeAssociationRecognition.mutualConnections.add('user_def456');
                capacity.freeAssociationRecognition.mutualConnections.add('user_ghi789');

                // Update trust scores
                capacity.freeAssociationRecognition.trustNetwork.set('user_abc123', 0.9);
                capacity.freeAssociationRecognition.trustNetwork.set('user_def456', 0.8);
                capacity.freeAssociationRecognition.trustNetwork.set('user_ghi789', 0.7);

                // Update reputation based on this data
                capacity.updateHolonsReputation();
            }

            generateUserId() {
                let userId = this.storage.getItem('user-id');
                if (!userId) {
                    userId = 'user_' + Math.random().toString(36).substr(2, 9);
                    this.storage.setItem('user-id', userId);
                }
                return userId;
            }

            saveUser() {
                const userData = {
                    ...this.currentUser,
                    capacity: {
                        ...this.currentUser.capacity,
                        offerings: Object.fromEntries(this.currentUser.capacity.offerings),
                        requests: Object.fromEntries(this.currentUser.capacity.requests)
                    }
                };
                this.storage.setItem('user-profile', JSON.stringify(userData));
            }

            loadCommitments() {
                const saved = this.storage.getItem('commitments');
                if (saved) {
                    const data = JSON.parse(saved);
                    data.forEach(commitmentData => {
                        const commitment = IntegratedCommitment.fromJSON(commitmentData);
                        this.commitments.set(commitment.id, commitment);
                    });
                } else {
                    this.initializeSampleCommitments();
                }
            }

            initializeSampleCommitments() {
                const samples = [
                    { 
                        text: "Want to jam with random instruments and share musical stories? üéµ", 
                        location: "Near the musicians area", 
                        threshold: 2,
                        demurrageRate: 0.05 
                    },
                    { 
                        text: "Impromptu philosophy discussion about technology and human connection ü§î", 
                        location: "Find a quiet spot", 
                        threshold: 4,
                        demurrageRate: 0.02 
                    },
                    { 
                        text: "Share a skill you've learned this year and teach someone üìö", 
                        location: "By the fountain", 
                        threshold: 3,
                        demurrageRate: 0.03 
                    },
                    { 
                        text: "Collaborative people-watching with creative commentary üë•", 
                        location: "Main path benches", 
                        threshold: 2,
                        demurrageRate: 0.04 
                    },
                    { 
                        text: "Spontaneous potluck food sharing and recipe exchange ü•ó", 
                        location: "Picnic area", 
                        threshold: 5,
                        demurrageRate: 0.02 
                    }
                ];

                samples.forEach((sample, index) => {
                    const commitment = new IntegratedCommitment(
                        Date.now() + index,
                        sample.text,
                        sample.location,
                        sample.threshold,
                        sample.demurrageRate,
                        'system'
                    );
                    this.commitments.set(commitment.id, commitment);
                });

                this.saveCommitments();
            }

            saveCommitments() {
                const data = Array.from(this.commitments.values()).map(c => c.toJSON());
                this.storage.setItem('commitments', JSON.stringify(data));
            }

            loadUserSwipes() {
                const saved = this.storage.getItem('user-swipes');
                if (saved) {
                    this.userSwipes = new Set(JSON.parse(saved));
                }
                
                const savedIndex = this.storage.getItem('current-index');
                if (savedIndex) {
                    this.currentIndex = parseInt(savedIndex);
                }
            }

            saveUserSwipes() {
                this.storage.setItem('user-swipes', JSON.stringify(Array.from(this.userSwipes)));
                this.storage.setItem('current-index', this.currentIndex.toString());
            }

            loadNotifications() {
                const saved = this.storage.getItem('notifications');
                if (saved) {
                    this.notifications = JSON.parse(saved);
                }
            }

            saveNotifications() {
                this.storage.setItem('notifications', JSON.stringify(this.notifications));
            }

            updateSystemStatus() {
                const statusDiv = document.getElementById('system-status');
                const systems = [
                    { name: 'Grassroots', connected: this.grassrootsService.connected },
                    { name: 'Free Assoc', connected: this.freeAssociationService.connected },
                    { name: 'Holons', connected: this.holonsService.connected },
                    { name: 'Telegram', connected: this.telegramService.connected }
                ];

                statusDiv.innerHTML = systems.map(sys => `
                    <div>
                        <span class="status-indicator ${sys.connected ? 'status-online' : 'status-offline'}"></span> 
                        ${sys.name}: ${sys.connected ? 'Online' : 'Offline'}
                    </div>
                `).join('');
            }

            async initializeIntegrations() {
                // Sync user capacity with Free Association
                if (this.freeAssociationService.connected) {
                    await this.freeAssociationService.syncCapacity(this.currentUser.capacity);
                }
            }

            startDemurrageTimer() {
                setInterval(() => {
                    this.updateDemurrage();
                }, 5000); // Update every 5 seconds for demo
            }

            updateDemurrage() {
                let changed = false;
                this.commitments.forEach(commitment => {
                    if (commitment.isExpired() && !commitment.expired) {
                        commitment.expired = true;
                        changed = true;
                    }
                });
                
                if (changed) {
                    this.saveCommitments();
                    this.updateCurrentCard();
                }
            }

            async getPersonalizedCommitmentFeed() {
                const activeCommitments = Array.from(this.commitments.values())
                    .filter(c => !c.isExpired())
                    .filter(c => !this.userSwipes.has(c.id));

                if (this.freeAssociationService.connected) {
                    // Use enhanced compatibility scoring with reputation and location
                    const recommendations = activeCommitments.map(commitment => {
                        const compatibility = this.currentUser.capacity.calculateCompatibility(
                            commitment, 
                            this.currentUser.capacity.location.current
                        );
                        const reasons = this.currentUser.capacity.getRecommendationReasons(commitment);
                        
                        return {
                            commitment,
                            compatibility,
                            reasons
                        };
                    });

                    // Sort by compatibility score, then by commitment value (demurrage)
                    return recommendations.sort((a, b) => {
                        // Primary sort: compatibility
                        if (Math.abs(a.compatibility - b.compatibility) > 0.1) {
                            return b.compatibility - a.compatibility;
                        }
                        // Secondary sort: remaining value (urgency)
                        return b.commitment.getCurrentValue() - a.commitment.getCurrentValue();
                    });
                }

                // Fallback: basic sorting by remaining value
                return activeCommitments
                    .map(commitment => ({
                        commitment,
                        compatibility: 0.5,
                        reasons: []
                    }))
                    .sort((a, b) => b.commitment.getCurrentValue() - a.commitment.getCurrentValue());
            }

            getCurrentCommitment() {
                return this.personalizedFeed ? this.personalizedFeed[this.currentIndex] : null;
            }

            async renderCurrentCard() {
                const container = document.getElementById('card-container');
                
                // Clear existing card
                const existingCard = container.querySelector('.prompt-card');
                if (existingCard) {
                    existingCard.remove();
                }

                // Get personalized feed
                this.personalizedFeed = await this.getPersonalizedCommitmentFeed();
                const currentItem = this.getCurrentCommitment();

                if (!currentItem) {
                    this.showNoMoreCards(container);
                    return;
                }

                this.createCard(container, currentItem);
            }

            createCard(container, item) {
                const { commitment, compatibility, reasons } = item;
                const card = document.createElement('div');
                card.className = 'prompt-card';
                
                if (compatibility > 0.6) {
                    card.classList.add('recommended');
                }
                
                this.currentCard = card;

                const valuePercent = Math.round(commitment.getCurrentValue() * 100);
                const voucherValue = Math.round(commitment.getCurrentVoucherValue());
                
                // Calculate creator reputation if available
                const creatorRep = this.getCreatorReputation(commitment.creator);

                card.innerHTML = `
                    <div class="system-info">
                        <div class="system-badge grassroots-badge">üå± ${voucherValue}</div>
                        <div class="system-badge free-assoc-badge">üéØ ${Math.round(compatibility * 100)}%</div>
                        ${commitment.offers.length > 0 ? '<div class="system-badge holons-badge">ü§ù Holons</div>' : ''}
                        ${creatorRep > 1.2 ? `<div class="system-badge" style="background: rgba(255, 215, 0, 0.3);">‚≠ê ${creatorRep.toFixed(1)}</div>` : ''}
                    </div>

                    <div class="prompt-text">${commitment.text}</div>
                    
                    ${reasons.length > 0 ? `
                        <div class="recommendation-reasons">
                            <div style="font-weight: 500; margin-bottom: 4px;">üéØ Why this matches you:</div>
                            ${reasons.slice(0, 3).map(reason => `<span class="reason">‚Ä¢ ${reason}</span>`).join('')}
                        </div>
                    ` : ''}
                    
                    <div class="swipe-icons">
                        <div class="swipe-icon left">‚úó</div>
                        <div class="swipe-icon right">‚úì</div>
                    </div>
                    
                    <div class="prompt-details">
                        <div class="location-info">üìç ${commitment.location}</div>
                        
                        ${commitment.activityDuration ? `
                            <div style="text-align: center; font-size: 14px; margin-bottom: 15px; opacity: 0.8; background: rgba(255,255,255,0.1); padding: 6px 12px; border-radius: 12px;">
                                ‚è±Ô∏è ${commitment.activityDuration}
                            </div>
                        ` : ''}
                        
                        ${commitment.offers.length > 0 ? `
                            <div class="offer-indicator">
                                ü§ù ${commitment.offers.length} offer${commitment.offers.length !== 1 ? 's' : ''} available
                            </div>
                        ` : ''}
                        
                        <div class="pool-status">
                            <div class="pool-count">${commitment.swipes.length}/${commitment.threshold} committed</div>
                        </div>
                        
                        <div class="decay-bar">
                            <div class="decay-progress" style="width: ${valuePercent}%"></div>
                        </div>
                        
                        <div class="value-display">
                            Value: ${valuePercent}% ‚Ä¢ Rate: ${(commitment.demurrageRate * 100).toFixed(1)}%/day
                        </div>
                        
                        ${commitment.triggered ? `
                            <div class="trigger-message">
                                Group formed! Join now! üöÄ
                                <div style="margin-top: 8px;">
                                    <button class="form-button" onclick="ui.simulateActivityCompletion('${commitment.id}')" style="font-size: 12px; padding: 6px 12px;">
                                        Simulate Activity Complete
                                    </button>
                                </div>
                            </div>
                        ` : ''}
                    </div>
                `;

                container.appendChild(card);
                this.setupCardGestures(card);
            }

            getCreatorReputation(creatorId) {
                // In a real app, this would fetch the creator's reputation from the network
                // For demo, return a simulated reputation
                if (creatorId === 'system') return 1.5;
                return 1.0 + Math.random() * 0.8; // Random reputation between 1.0-1.8
            }

            simulateActivityCompletion(commitmentId) {
                const commitment = this.app.commitments.get(parseInt(commitmentId));
                if (!commitment) return;
                
                // Generate simulated participants with skills
                const participants = commitment.swipes.slice(0, commitment.threshold).map((userId, index) => ({
                    userId: userId,
                    name: `User ${userId.slice(-3)}`,
                    skills: this.generateParticipantSkills(commitment)
                }));
                
                this.showAppreciationModal(commitment.text, participants);
            }

            generateParticipantSkills(commitment) {
                const commitmentSkills = commitment.extractSkills();
                const additionalSkills = ['communication', 'creativity', 'organization', 'enthusiasm'];
                
                // Combine commitment-relevant skills with some additional ones
                const skills = [...commitmentSkills];
                additionalSkills.forEach(skill => {
                    if (Math.random() > 0.6) skills.push(skill);
                });
                
                return skills.slice(0, 4); // Limit to 4 skills max
            }

            setupCardGestures(card) {
                let startX = 0;
                let currentX = 0;
                let isDragging = false;

                const handleStart = (clientX) => {
                    if (this.isAnimating) return;
                    startX = clientX;
                    currentX = clientX;
                    isDragging = true;
                    card.classList.add('swiping');
                };

                const handleMove = (clientX) => {
                    if (!isDragging || this.isAnimating) return;
                    currentX = clientX;
                    const diffX = currentX - startX;
                    const rotation = diffX * 0.1;
                    
                    card.style.transform = `translateX(${diffX}px) rotate(${rotation}deg)`;

                    const leftIcon = card.querySelector('.swipe-icon.left');
                    const rightIcon = card.querySelector('.swipe-icon.right');
                    
                    if (diffX < -50) {
                        leftIcon.classList.add('show');
                        rightIcon.classList.remove('show');
                    } else if (diffX > 50) {
                        rightIcon.classList.add('show');
                        leftIcon.classList.remove('show');
                    } else {
                        leftIcon.classList.remove('show');
                        rightIcon.classList.remove('show');
                    }
                };

                const handleEnd = () => {
                    if (!isDragging || this.isAnimating) return;
                    isDragging = false;
                    
                    const diffX = currentX - startX;
                    
                    const leftIcon = card.querySelector('.swipe-icon.left');
                    const rightIcon = card.querySelector('.swipe-icon.right');
                    leftIcon.classList.remove('show');
                    rightIcon.classList.remove('show');

                    if (Math.abs(diffX) > 100) {
                        if (diffX > 0) {
                            this.swipeRight();
                        } else {
                            this.swipeLeft();
                        }
                    } else {
                        card.classList.remove('swiping');
                        card.style.transform = '';
                    }
                };

                // Touch events
                card.addEventListener('touchstart', (e) => {
                    handleStart(e.touches[0].clientX);
                }, { passive: true });

                card.addEventListener('touchmove', (e) => {
                    handleMove(e.touches[0].clientX);
                }, { passive: true });

                card.addEventListener('touchend', handleEnd, { passive: true });

                // Mouse events
                card.addEventListener('mousedown', (e) => {
                    handleStart(e.clientX);
                });

                card.addEventListener('mousemove', (e) => {
                    handleMove(e.clientX);
                });

                card.addEventListener('mouseup', handleEnd);
                card.addEventListener('mouseleave', handleEnd);
            }

            swipeLeft() {
                if (this.isAnimating) return;
                this.animateSwipe('left', false);
            }

            async swipeRight() {
                if (this.isAnimating) return;
                const currentItem = this.getCurrentCommitment();
                if (currentItem && !currentItem.commitment.isExpired()) {
                    await this.handleSwipe(currentItem.commitment, true);
                }
                this.animateSwipe('right', true);
            }

            async handleSwipe(commitment, liked) {
                this.currentUser.updateStats({
                    totalSwipes: this.currentUser.stats.totalSwipes + 1,
                    rightSwipes: liked ? this.currentUser.stats.rightSwipes + 1 : this.currentUser.stats.rightSwipes
                });

                if (liked) {
                    this.userSwipes.add(commitment.id);
                    const triggered = commitment.addCapacity(this.currentUser.userId);
                    
                    if (triggered) {
                        await this.handleCommitmentTriggered(commitment);
                        this.currentUser.updateStats({
                            groupsJoined: this.currentUser.stats.groupsJoined + 1
                        });
                    }

                    // Create Grassroots voucher participation
                    if (this.grassrootsService.connected) {
                        await this.grassrootsService.createVoucher(commitment);
                    }
                }

                this.saveUser();
                this.saveCommitments();
                this.saveUserSwipes();
            }

            async handleCommitmentTriggered(commitment) {
                console.log('üéâ Commitment triggered!', commitment.text);
                
                // Create Telegram group
                if (this.telegramService.connected) {
                    const groupData = await this.telegramService.createGroupChat(
                        commitment, 
                        commitment.swipes
                    );
                    
                    if (groupData) {
                        commitment.telegramGroupId = groupData.chat_id;
                        commitment.telegramInviteLink = groupData.invite_link;
                        
                        this.addNotification({
                            type: 'group_created',
                            title: 'Group Chat Created! üéâ',
                            message: `Your commitment "${commitment.text.substring(0, 50)}..." reached its threshold. Join the group chat to coordinate!`,
                            inviteLink: groupData.invite_link,
                            timestamp: Date.now()
                        });
                    }
                }

                // Show browser notification
                if ('Notification' in window && Notification.permission === 'granted') {
                    new Notification(`Group formed! ${commitment.text.substring(0, 50)}...`, {
                        body: `Go to: ${commitment.location} | ${commitment.swipes.length} people ready!`,
                        icon: '/favicon.ico'
                    });
                }
            }

            addNotification(notification) {
                this.notifications.unshift(notification);
                if (this.notifications.length > 50) {
                    this.notifications.splice(50);
                }
                this.saveNotifications();
                this.updateNotificationBadge();
            }

            updateNotificationBadge() {
                const badge = document.getElementById('notification-badge');
                const unreadCount = this.notifications.filter(n => !n.read).length;
                
                if (badge) {
                    if (unreadCount > 0) {
                        badge.textContent = unreadCount;
                        badge.style.display = 'block';
                    } else {
                        badge.style.display = 'none';
                    }
                }
            }

            animateSwipe(direction, liked) {
                if (!this.currentCard) return;
                
                this.isAnimating = true;
                this.currentCard.classList.remove('swiping');
                this.currentCard.classList.add(`swipe-${direction}`);

                setTimeout(() => {
                    this.nextCard();
                    this.isAnimating = false;
                }, 300);
            }

            nextCard() {
                this.currentIndex++;
                this.saveUserSwipes();
                this.renderCurrentCard();
            }

            updateCurrentCard() {
                // Update the current card's display if needed
                if (this.currentCard) {
                    const currentItem = this.getCurrentCommitment();
                    if (currentItem) {
                        const valuePercent = Math.round(currentItem.commitment.getCurrentValue() * 100);
                        const progressBar = this.currentCard.querySelector('.decay-progress');
                        if (progressBar) {
                            progressBar.style.width = valuePercent + '%';
                        }
                    }
                }
            }

            showNoMoreCards(container) {
                container.innerHTML = `
                    <div class="no-more-cards">
                        <h3>All caught up! üéâ</h3>
                        <p>Check back later for new commitments</p>
                        <button class="refresh-btn" onclick="app.restart()">Start over</button>
                    </div>
                `;
            }

            restart() {
                this.currentIndex = 0;
                this.saveUserSwipes();
                this.renderCurrentCard();
            }

            async createCommitment(text, location, threshold, activityDuration, demurrageRate) {
                const commitment = new IntegratedCommitment(
                    Date.now(),
                    text,
                    location,
                    threshold,
                    demurrageRate / 100, // Convert percentage to decimal
                    this.currentUser.userId
                );
                
                commitment.activityDuration = activityDuration;
                
                // Create Grassroots voucher
                if (this.grassrootsService.connected) {
                    const voucherResult = await this.grassrootsService.createVoucher(commitment);
                    if (voucherResult) {
                        commitment.grassrootsAddress = voucherResult.voucher_address;
                    }
                }

                this.commitments.set(commitment.id, commitment);
                this.currentUser.updateStats({
                    promptsCreated: this.currentUser.stats.promptsCreated + 1
                });
                
                this.saveCommitments();
                this.saveUser();
                
                return commitment;
            }
        }

        // ====================
        // UI CONTROLLER
        // ====================

        class IntegratedUIController {
            constructor(app) {
                this.app = app;
                this.currentScreen = 'main-screen';
                this.setupEventListeners();
            }

            setupEventListeners() {
                // Request notification permission
                if ('Notification' in window && Notification.permission === 'default') {
                    Notification.requestPermission();
                }
            }

            handleReject() {
                this.app.swipeLeft();
            }

            handleAccept() {
                this.app.swipeRight();
            }

            showMainScreen() {
                document.querySelectorAll('.screen').forEach(screen => {
                    screen.classList.remove('active');
                });
                document.querySelectorAll('.nav-item').forEach(item => {
                    item.classList.remove('active');
                });
                document.getElementById('main-screen').classList.add('active');
                this.currentScreen = 'main-screen';
            }

            showScreen(screenId) {
                document.querySelectorAll('.screen').forEach(screen => {
                    screen.classList.remove('active');
                });
                document.querySelectorAll('.nav-item').forEach(item => {
                    item.classList.remove('active');
                });
                document.getElementById(screenId).classList.add('active');
                this.currentScreen = screenId;
                
                // Set active navigation item
                if (screenId === 'profile-screen') {
                    document.querySelector('[onclick="ui.showProfile()"]').classList.add('active');
                } else if (screenId === 'create-screen') {
                    document.querySelector('[onclick="ui.showCreatePrompt()"]').classList.add('active');
                } else if (screenId === 'chats-screen') {
                    document.querySelector('[onclick="ui.showTelegramChats()"]').classList.add('active');
                } else if (screenId === 'map-screen') {
                    document.getElementById('map-nav').classList.add('active');
                } else if (screenId === 'search-screen') {
                    document.querySelector('[onclick="ui.showSearch()"]').classList.add('active');
                }
            }

            showProfile() {
                this.updateProfileDisplay();
                this.showScreen('profile-screen');
            }

            updateProfileDisplay() {
                const user = this.app.currentUser;
                const initials = user.userId.substring(5, 7).toUpperCase();
                
                document.getElementById('profile-avatar').textContent = initials;
                document.getElementById('profile-id').textContent = user.userId;
                document.getElementById('total-swipes').textContent = user.stats.totalSwipes;
                document.getElementById('groups-joined').textContent = user.stats.groupsJoined;
                document.getElementById('prompts-created').textContent = user.stats.promptsCreated;
                document.getElementById('reputation-score').textContent = user.capacity.reputation.toFixed(1);

                // Update reputation metrics
                document.getElementById('holons-rating').textContent = 
                    user.capacity.holonsAppreciation.averageRating.toFixed(1);
                
                const totalEndorsements = Array.from((user.capacity.freeAssociationRecognition.skillEndorsements?.values?.() || [])())
                    .reduce((sum, endorsements) => sum + endorsements.length, 0);
                document.getElementById('endorsements-count').textContent = totalEndorsements;
                
                document.getElementById('trust-network').textContent = 
                    user.capacity.freeAssociationRecognition.mutualConnections.size;
                
                document.getElementById('reliability-score').textContent = 
                    Math.round(user.capacity.holonsAppreciation.reliabilityScore * 100) + '%';

                // Update location info
                document.getElementById('current-location').textContent = 
                    user.capacity.location.current || 'Not set';
                
                const mobilityText = user.capacity.location.mobility > 0.8 ? 'High mobility' :
                                   user.capacity.location.mobility > 0.5 ? 'Medium mobility' : 'Local only';
                document.getElementById('mobility-range').textContent = mobilityText;
                
                const groupPrefText = {
                    'small': 'Small groups (2-3 people)',
                    'medium': 'Medium groups (3-6 people)',
                    'large': 'Large groups (6+ people)'
                };
                document.getElementById('group-preference').textContent = 
                    groupPrefText[user.capacity.preferences.groupSizePreference] || 'No preference';

                this.updateSkillsList();
                this.updateInterestsList();
                this.updateRecentAppreciations();
            }

            updateSkillsList() {
                const container = document.getElementById('skills-list');
                const offerings = this.app.currentUser.capacity.offerings;
                const endorsements = this.app.currentUser.capacity.freeAssociationRecognition.skillEndorsements;
                
                if (offerings.size === 0) {
                    container.innerHTML = '<div style="opacity: 0.7; text-align: center; padding: 20px;">No skills added yet</div>';
                    return;
                }

                container.innerHTML = Array.from(offerings.entries()).map(([skill, data]) => {
                    const skillEndorsements = endorsements.get(skill) || [];
                    const endorsementCount = skillEndorsements.length;
                    
                    return `
                        <div class="capacity-item">
                            <div>
                                <div style="font-weight: 500; display: flex; align-items: center; gap: 8px;">
                                    ${skill}
                                    ${endorsementCount > 0 ? `
                                        <span style="background: rgba(76, 175, 80, 0.3); padding: 2px 6px; border-radius: 8px; font-size: 10px;">
                                            ${endorsementCount} endorsement${endorsementCount !== 1 ? 's' : ''}
                                        </span>
                                    ` : ''}
                                </div>
                                <div style="font-size: 12px; opacity: 0.7;">
                                    Offered ${data.timesOffered} times
                                    ${endorsementCount > 0 ? ` ‚Ä¢ Peer validated` : ''}
                                </div>
                            </div>
                            <div class="proficiency-bar">
                                <div class="proficiency-fill" style="width: ${data.proficiency * 100}%"></div>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            updateRecentAppreciations() {
                const container = document.getElementById('recent-appreciations');
                const recent = this.app.currentUser.capacity.holonsAppreciation.received.slice(-3);
                
                if (recent.length === 0) {
                    container.innerHTML = '<div style="opacity: 0.7; text-align: center; padding: 15px; font-size: 14px;">No appreciations received yet</div>';
                    return;
                }
                
                container.innerHTML = `
                    <div style="font-weight: 500; margin-bottom: 10px; font-size: 14px;">Recent Appreciations</div>
                    ${recent.map(appreciation => `
                        <div style="background: rgba(255, 255, 255, 0.05); padding: 10px; border-radius: 8px; margin-bottom: 8px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
                                <div style="font-weight: 500; font-size: 13px;">${appreciation.activityType}</div>
                                <div style="color: #feca57;">
                                    ${'‚òÖ'.repeat(appreciation.rating)}${'‚òÜ'.repeat(5 - appreciation.rating)}
                                </div>
                            </div>
                            ${appreciation.comment ? `
                                <div style="font-size: 12px; opacity: 0.8; font-style: italic;">"${appreciation.comment}"</div>
                            ` : ''}
                            <div style="font-size: 11px; opacity: 0.6; margin-top: 4px;">
                                ${this.formatTime(appreciation.timestamp)}
                            </div>
                        </div>
                    `).join('')}
                `;
            }

            updateInterestsList() {
                const container = document.getElementById('interests-list');
                const requests = this.app.currentUser.capacity.requests;
                
                if (requests.size === 0) {
                    container.innerHTML = '<div style="opacity: 0.7; text-align: center; padding: 20px;">No learning interests added yet</div>';
                    return;
                }

                container.innerHTML = Array.from(requests.entries()).map(([skill, data]) => `
                    <div class="capacity-item">
                        <div>
                            <div style="font-weight: 500;">${skill}</div>
                            <div style="font-size: 12px; opacity: 0.7;">Requested ${data.timesRequested} times</div>
                        </div>
                        <div style="font-size: 12px; opacity: 0.8;">Urgency: ${Math.round(data.urgency * 100)}%</div>
                    </div>
                `).join('');
            }

            showAddSkillModal() {
                this.showModal('Add Skill', `
                    <div class="form-group">
                        <label class="form-label">Skill name</label>
                        <input type="text" class="form-input" id="skill-name" placeholder="e.g., guitar, cooking, photography">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Proficiency level</label>
                        <select class="form-input" id="skill-proficiency">
                            <option value="0.2">Beginner</option>
                            <option value="0.5" selected>Intermediate</option>
                            <option value="0.8">Advanced</option>
                            <option value="1.0">Expert</option>
                        </select>
                    </div>
                    <div style="display: flex; gap: 10px; justify-content: flex-end;">
                        <button class="form-button secondary" onclick="this.closest('.overlay').remove()">Cancel</button>
                        <button class="form-button" onclick="ui.addSkill()">Add Skill</button>
                    </div>
                `);
            }

            addSkill() {
                const skillName = document.getElementById('skill-name').value.trim();
                const proficiency = parseFloat(document.getElementById('skill-proficiency').value);
                
                if (skillName) {
                    this.app.currentUser.capacity.addOffering(skillName, proficiency);
                    this.app.saveUser();
                    this.updateSkillsList();
                    document.querySelector('.overlay').remove();
                }
            }

            showAddInterestModal() {
                this.showModal('Add Learning Interest', `
                    <div class="form-group">
                        <label class="form-label">What would you like to learn?</label>
                        <input type="text" class="form-input" id="interest-name" placeholder="e.g., meditation, coding, dancing">
                    </div>
                    <div class="form-group">
                        <label class="form-label">How urgently?</label>
                        <select class="form-input" id="interest-urgency">
                            <option value="0.3">Casual interest</option>
                            <option value="0.6" selected>Moderate interest</option>
                            <option value="0.9">Very interested</option>
                        </select>
                    </div>
                    <div style="display: flex; gap: 10px; justify-content: flex-end;">
                        <button class="form-button secondary" onclick="this.closest('.overlay').remove()">Cancel</button>
                        <button class="form-button" onclick="ui.addInterest()">Add Interest</button>
                    </div>
                `);
            }

            showLocationModal() {
                const user = this.app.currentUser;
                this.showModal('Location & Preferences', `
                    <div class="form-group">
                        <label class="form-label">Current Location</label>
                        <input type="text" class="form-input" id="user-location" 
                               value="${user.capacity.location.current || ''}" 
                               placeholder="e.g., Mauerpark, Berlin">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Mobility Range</label>
                        <select class="form-input" id="user-mobility">
                            <option value="0.3" ${user.capacity.location.mobility <= 0.3 ? 'selected' : ''}>Local only (same area)</option>
                            <option value="0.6" ${user.capacity.location.mobility > 0.3 && user.capacity.location.mobility <= 0.6 ? 'selected' : ''}>Medium range (same district)</option>
                            <option value="1.0" ${user.capacity.location.mobility > 0.6 ? 'selected' : ''}>High mobility (anywhere in city)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Group Size Preference</label>
                        <select class="form-input" id="group-size-pref">
                            <option value="small" ${user.capacity.preferences.groupSizePreference === 'small' ? 'selected' : ''}>Small groups (2-3 people)</option>
                            <option value="medium" ${user.capacity.preferences.groupSizePreference === 'medium' ? 'selected' : ''}>Medium groups (3-6 people)</option>
                            <option value="large" ${user.capacity.preferences.groupSizePreference === 'large' ? 'selected' : ''}>Large groups (6+ people)</option>
                        </select>
                    </div>
                    <div style="display: flex; gap: 10px; justify-content: flex-end;">
                        <button class="form-button secondary" onclick="this.closest('.overlay').remove()">Cancel</button>
                        <button class="form-button" onclick="ui.saveLocationPreferences()">Save</button>
                    </div>
                `);
            }

            saveLocationPreferences() {
                const location = document.getElementById('user-location').value.trim();
                const mobility = parseFloat(document.getElementById('user-mobility').value);
                const groupSize = document.getElementById('group-size-pref').value;
                
                this.app.currentUser.capacity.location.current = location;
                this.app.currentUser.capacity.location.mobility = mobility;
                this.app.currentUser.capacity.preferences.groupSizePreference = groupSize;
                
                this.app.saveUser();
                this.updateProfileDisplay();
                document.querySelector('.overlay').remove();
            }

            // Appreciation system for post-activity feedback
            showAppreciationModal(activityTitle, participants) {
                this.showModal('Share Appreciation', `
                    <div style="margin-bottom: 20px;">
                        <h4 style="margin-bottom: 10px;">${activityTitle}</h4>
                        <p style="opacity: 0.8; font-size: 14px;">Rate and appreciate your fellow participants</p>
                    </div>
                    
                    ${participants.map(participant => `
                        <div style="background: rgba(255, 255, 255, 0.05); padding: 15px; border-radius: 10px; margin-bottom: 15px;">
                            <div style="font-weight: 500; margin-bottom: 10px;">üë§ ${participant.name || participant.userId}</div>
                            
                            <div class="form-group">
                                <label class="form-label">Rating</label>
                                <div style="display: flex; gap: 5px; margin-bottom: 10px;">
                                    ${[1,2,3,4,5].map(star => `
                                        <span class="star-rating" data-participant="${participant.userId}" data-rating="${star}" 
                                              style="font-size: 24px; cursor: pointer; color: #666;" 
                                              onclick="ui.setRating(this)">‚òÜ</span>
                                    `).join('')}
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Skills to endorse</label>
                                <div style="display: flex; flex-wrap: wrap; gap: 5px; margin-bottom: 10px;">
                                    ${participant.skills.map(skill => `
                                        <button class="filter-btn skill-endorse" 
                                                data-participant="${participant.userId}" 
                                                data-skill="${skill}"
                                                onclick="ui.toggleSkillEndorsement(this)">
                                            ${skill}
                                        </button>
                                    `).join('')}
                                </div>
                            </div>
                            
                            <textarea class="form-textarea" 
                                      id="comment-${participant.userId}" 
                                      placeholder="Optional: Share what you appreciated about working with them..."
                                      style="height: 60px;"></textarea>
                        </div>
                    `).join('')}
                    
                    <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                        <button class="form-button secondary" onclick="this.closest('.overlay').remove()">Skip</button>
                        <button class="form-button" onclick="ui.submitAppreciations('${activityTitle}')">Submit Appreciations</button>
                    </div>
                `);
            }

            setRating(starElement) {
                const participantId = starElement.dataset.participant;
                const rating = parseInt(starElement.dataset.rating);
                
                // Update visual state
                const allStars = document.querySelectorAll(`[data-participant="${participantId}"].star-rating`);
                allStars.forEach((star, index) => {
                    if (index < rating) {
                        star.textContent = '‚òÖ';
                        star.style.color = '#feca57';
                    } else {
                        star.textContent = '‚òÜ';
                        star.style.color = '#666';
                    }
                });
                
                // Store rating
                starElement.closest('.overlay').dataset[`rating-${participantId}`] = rating;
            }

            toggleSkillEndorsement(button) {
                button.classList.toggle('active');
                if (button.classList.contains('active')) {
                    button.style.background = 'rgba(76, 175, 80, 0.3)';
                } else {
                    button.style.background = '';
                }
            }

            submitAppreciations(activityTitle) {
                const modal = document.querySelector('.overlay');
                const participants = Array.from(modal.querySelectorAll('[data-participant]'))
                    .map(el => el.dataset.participant)
                    .filter((value, index, self) => self.indexOf(value) === index); // Unique values
                
                participants.forEach(participantId => {
                    const rating = parseInt(modal.dataset[`rating-${participantId}`] || '3');
                    const comment = document.getElementById(`comment-${participantId}`)?.value || '';
                    const endorsedSkills = Array.from(modal.querySelectorAll(`[data-participant="${participantId}"].skill-endorse.active`))
                        .map(btn => btn.dataset.skill);
                    
                    // Record appreciation
                    this.recordAppreciation(participantId, activityTitle, rating, comment, endorsedSkills);
                });
                
                modal.remove();
                alert('Thank you for your feedback! This helps build trust in the community. üôè');
            }

            addInterest() {
                const interestName = document.getElementById('interest-name').value.trim();
                const urgency = parseFloat(document.getElementById('interest-urgency').value);
                
                if (interestName) {
                    this.app.currentUser.capacity.addRequest(interestName, urgency);
                    this.app.saveUser();
                    this.updateInterestsList();
                    document.querySelector('.overlay').remove();
                }
            }

            recordAppreciation(participantId, activityTitle, rating, comment, endorsedSkills) {
                // In a real app, this would be sent to the server and the participant's profile
                console.log('Recording appreciation:', {
                    to: participantId,
                    activity: activityTitle,
                    rating,
                    comment,
                    endorsedSkills,
                    from: this.app.currentUser.userId
                });
                
                // Simulate receiving appreciation (for demo purposes)
                if (Math.random() > 0.5) { // 50% chance to simulate reciprocal appreciation
                    this.app.currentUser.capacity.receiveAppreciation(
                        participantId,
                        activityTitle,
                        3 + Math.floor(Math.random() * 3), // 3-5 rating
                        'Great collaboration!'
                    );
                    
                    this.app.saveUser();
                }
                
                // Record skill endorsements
                endorsedSkills.forEach(skill => {
                    // Simulate mutual skill recognition
                    this.app.currentUser.capacity.endorseSkill(participantId, skill, 0.8 + Math.random() * 0.2);
                });
                
                this.app.saveUser();
            }

            showCreatePrompt() {
                this.showScreen('create-screen');
            }

            async createCommitment() {
                const text = document.getElementById('commitment-text').value.trim();
                const location = document.getElementById('commitment-location').value.trim();
                const threshold = parseInt(document.getElementById('commitment-threshold').value);
                const activityDuration = document.getElementById('activity-duration').value;
                const demurrageRate = parseFloat(document.getElementById('demurrage-rate').value);
                
                if (!text || !location) {
                    alert('Please fill in all required fields');
                    return;
                }
                
                const commitment = await this.app.createCommitment(
                    text, location, threshold, activityDuration, demurrageRate
                );
                
                // Clear form
                document.getElementById('commitment-text').value = '';
                document.getElementById('commitment-location').value = '';
                document.getElementById('commitment-threshold').value = '3';
                document.getElementById('activity-duration').value = '1 hour';
                document.getElementById('demurrage-rate').value = '2.0';
                
                alert('Commitment created! üéâ\nIt\'s now available for others to discover.');
                this.showMainScreen();
            }

            showTelegramChats() {
                this.updateChatsList();
                this.showScreen('chats-screen');
            }

            showSearch() {
                this.showScreen('search-screen');
                setTimeout(() => {
                    const searchInput = document.getElementById('search-input-screen');
                    if (searchInput) searchInput.focus();
                }, 100);
            }

            toggleMapView() {
                this.updateMapView();
                this.showScreen('map-screen');
            }

            updateMapView() {
                const mapStats = document.getElementById('map-stats');
                const locationList = document.getElementById('location-list');
                
                const activeCommitments = Array.from(this.app.commitments.values()).filter(c => !c.isExpired());
                const locations = this.getUniqueLocations(activeCommitments);
                
                if (mapStats) {
                    mapStats.textContent = `${activeCommitments.length} active commitments across ${locations.length} locations`;
                }
                
                if (locationList) {
                    if (locations.length === 0) {
                        locationList.innerHTML = '<div class="no-chats">No active locations</div>';
                        return;
                    }
                    
                    locationList.innerHTML = locations.map(location => `
                        <div class="location-item">
                            <div class="location-name">üìç ${location.name}</div>
                            <div class="location-count">${location.count} commitment${location.count !== 1 ? 's' : ''}</div>
                        </div>
                    `).join('');
                }
            }

            getUniqueLocations(commitments) {
                const locations = {};
                commitments.forEach(commitment => {
                    locations[commitment.location] = (locations[commitment.location] || 0) + 1;
                });
                return Object.keys(locations).map(location => ({
                    name: location,
                    count: locations[location]
                }));
            }

            performSearchScreen() {
                const query = document.getElementById('search-input-screen').value;
                this.displaySearchResults(query);
            }

            filterByCategory(category) {
                // Update filter button states
                document.querySelectorAll('.filter-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                event.target.classList.add('active');
                
                if (category === 'all') {
                    this.displaySearchResults('');
                    return;
                }
                
                const commitments = Array.from(this.app.commitments.values());
                const results = commitments.filter(commitment => {
                    const skills = commitment.extractSkills();
                    return skills.includes(category);
                });
                
                this.displaySearchResults('', results);
            }

            displaySearchResults(query, customResults = null) {
                const resultsContainer = document.getElementById('search-results-screen');
                
                if (!query.trim() && !customResults) {
                    resultsContainer.innerHTML = '<div class="no-chats">Start typing or use filters to find prompts...</div>';
                    return;
                }
                
                let results;
                if (customResults) {
                    results = customResults;
                } else {
                    results = this.searchCommitments(query);
                }
                
                if (results.length === 0) {
                    resultsContainer.innerHTML = '<div class="no-chats">No commitments found matching your criteria.</div>';
                    return;
                }
                
                resultsContainer.innerHTML = results.map(commitment => {
                    const status = commitment.expired ? 'Expired' : 
                                 commitment.triggered ? 'Active Group' : 
                                 'Available';
                    
                    return `
                        <div class="search-result" onclick="ui.jumpToCommitment(${commitment.id})">
                            <div class="result-text">${commitment.text}</div>
                            <div class="result-meta">
                                üìç ${commitment.location} ‚Ä¢ ${commitment.swipes.length}/${commitment.threshold} interested ‚Ä¢ ${status}${commitment.activityDuration ? ` ‚Ä¢ ‚è±Ô∏è ${commitment.activityDuration}` : ''}
                            </div>
                        </div>
                    `;
                }).join('');
            }

            searchCommitments(query) {
                if (!query.trim()) return [];
                
                const searchTerm = query.toLowerCase();
                return Array.from(this.app.commitments.values()).filter(commitment => {
                    return commitment.text.toLowerCase().includes(searchTerm) ||
                           commitment.location.toLowerCase().includes(searchTerm) ||
                           commitment.extractSkills().some(skill => skill.includes(searchTerm));
                });
            }

            jumpToCommitment(commitmentId) {
                // Find the commitment in the personalized feed
                const feedIndex = this.app.personalizedFeed?.findIndex(item => item.commitment.id === commitmentId);
                if (feedIndex !== -1) {
                    this.app.currentIndex = feedIndex;
                    this.app.renderCurrentCard();
                    this.showMainScreen();
                }
            }

            // Update notification badge periodically
            updateNotificationBadgeIfNeeded() {
                this.app.updateNotificationBadge();
            }

            updateChatsList() {
                const container = document.getElementById('telegram-groups-list');
                const groups = this.app.telegramService.getAllGroups();
                
                if (groups.length === 0) {
                    container.innerHTML = `
                        <div class="no-chats">
                            <div style="font-size: 40px; margin-bottom: 10px;">üí¨</div>
                            <div>No active group chats yet</div>
                            <div style="font-size: 12px; margin-top: 5px;">Join groups by swiping right on commitments!</div>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = groups.map(group => `
                    <div class="telegram-item" onclick="ui.openTelegramGroup('${group.invite_link}')">
                        <div class="telegram-title">üì± ${group.title}</div>
                        <div class="telegram-meta">
                            üë• ${group.participants.length} participants ‚Ä¢ ${this.formatTime(group.created_at)}
                        </div>
                    </div>
                `).join('');
            }

            showNotifications() {
                this.updateNotificationsList();
                this.showScreen('notifications-screen');
            }

            updateNotificationsList() {
                const container = document.getElementById('notifications-list');
                const notifications = this.app.notifications;
                
                if (notifications.length === 0) {
                    container.innerHTML = `
                        <div class="no-chats">
                            <div style="font-size: 40px; margin-bottom: 10px;">üîî</div>
                            <div>No notifications yet</div>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = notifications.map((notification, index) => `
                    <div class="capacity-item ${notification.read ? 'read' : 'unread'}" 
                         onclick="ui.markNotificationRead(${index})"
                         style="cursor: pointer; ${notification.read ? 'opacity: 0.6;' : ''}">
                        <div>
                            <div style="font-weight: 500;">${notification.title}</div>
                            <div style="font-size: 14px; margin: 5px 0;">${notification.message}</div>
                            <div style="font-size: 12px; opacity: 0.7;">${this.formatTime(notification.timestamp)}</div>
                            ${notification.inviteLink ? `
                                <button class="form-button" onclick="event.stopPropagation(); ui.openTelegramGroup('${notification.inviteLink}')" style="margin-top: 10px; font-size: 12px; padding: 6px 12px;">
                                    Join Group Chat üí¨
                                </button>
                            ` : ''}
                        </div>
                    </div>
                `).join('');
            }

            markNotificationRead(index) {
                if (this.app.notifications[index]) {
                    this.app.notifications[index].read = true;
                    this.app.saveNotifications();
                    this.app.updateNotificationBadge();
                    this.updateNotificationsList();
                }
            }

            openTelegramGroup(inviteLink) {
                if (inviteLink) {
                    window.open(inviteLink, '_blank');
                }
            }

            showModal(title, content) {
                const overlay = document.createElement('div');
                overlay.className = 'overlay show';
                overlay.innerHTML = `
                    <div class="overlay-content">
                        <button class="close-btn" onclick="this.parentElement.parentElement.remove()">√ó</button>
                        <div style="margin-bottom: 20px;">
                            <h3>${title}</h3>
                        </div>
                        ${content}
                    </div>
                `;
                
                document.body.appendChild(overlay);
                
                overlay.addEventListener('click', (e) => {
                    if (e.target === overlay) {
                        overlay.remove();
                    }
                });
            }

            formatTime(timestamp) {
                const diff = Date.now() - timestamp;
                const minutes = Math.floor(diff / (60 * 1000));
                const hours = Math.floor(diff / (60 * 60 * 1000));
                const days = Math.floor(diff / (24 * 60 * 60 * 1000));
                
                if (minutes < 60) return `${minutes}m ago`;
                if (hours < 24) return `${hours}h ago`;
                return `${days}d ago`;
            }
        }

        // ====================
        // SIMPLE TESTING FRAMEWORK
        // ====================

        class SimpleTestFramework {
            constructor() {
                this.results = [];
            }

            test(name, testFn) {
                try {
                    testFn();
                    this.results.push({ name, passed: true });
                } catch (error) {
                    this.results.push({ name, passed: false, error: error.message });
                }
            }

            expect(actual) {
                return {
                    toBe: (expected) => {
                        if (actual !== expected) {
                            throw new Error(`Expected ${expected}, got ${actual}`);
                        }
                    },
                    toBeTruthy: () => {
                        if (!actual) {
                            throw new Error(`Expected truthy value, got ${actual}`);
                        }
                    }
                };
            }

            displayResults() {
                const container = document.getElementById('test-results');
                const passed = this.results.filter(r => r.passed).length;
                const total = this.results.length;
                
                container.innerHTML = `
                    <div style="font-weight: bold; margin-bottom: 5px;">
                        Tests: ${passed}/${total} passed
                    </div>
                    ${this.results.slice(0, 8).map(result => `
                        <div class="${result.passed ? 'test-pass' : 'test-fail'}">
                            ${result.passed ? '‚úì' : '‚úó'} ${result.name.substring(0, 40)}...
                        </div>
                    `).join('')}
                `;
            }
        }

        function runIntegratedTests() {
            const test = new SimpleTestFramework();

            test.test('should create integrated commitment', () => {
                const commitment = new IntegratedCommitment(1, 'Test', 'Location', 2, 0.02);
                test.expect(commitment.getCurrentValue()).toBeTruthy();
                test.expect(commitment.extractSkills()).toBeTruthy();
            });

            test.test('should create enhanced capacity with reputation', () => {
                const capacity = new EnhancedCapacity('user1');
                capacity.addOffering('music', 0.7);
                test.expect(capacity.offerings.has('music')).toBeTruthy();
                test.expect(capacity.reputation).toBeTruthy();
            });

            test.test('should calculate compatibility with reputation and location', () => {
                const capacity = new EnhancedCapacity('user1');
                capacity.addOffering('music', 0.8);
                capacity.reputation = 1.5; // High reputation
                capacity.location.current = 'Mauerpark';
                
                const commitment = new IntegratedCommitment(1, 'Music jam session', 'Mauerpark', 2);
                const score = capacity.calculateCompatibility(commitment, 'Mauerpark');
                test.expect(score > 0.5).toBeTruthy();
            });

            test.test('should handle appreciation system', () => {
                const capacity = new EnhancedCapacity('user1');
                capacity.receiveAppreciation('user2', 'Music jam', 5, 'Great musician!');
                test.expect(capacity.holonsAppreciation.received.length).toBeTruthy();
                test.expect(capacity.reputation > 1.0).toBeTruthy();
            });

            test.test('should handle skill endorsements', () => {
                const capacity = new EnhancedCapacity('user1');
                capacity.addOffering('music', 0.6);
                capacity.receiveSkillEndorsement('user2', 'music', 0.9);
                
                const endorsements = capacity.freeAssociationRecognition.skillEndorsements.get('music');
                test.expect(endorsements.length > 0).toBeTruthy();
                test.expect(capacity.freeAssociationRecognition.mutualConnections.has('user2')).toBeTruthy();
            });

            test.test('should handle swipe integration with reputation', () => {
                const commitment = new IntegratedCommitment(1, 'Test', 'Location', 2);
                const triggered = commitment.addCapacity('user1');
                test.expect(triggered).toBe(false);
                const triggered2 = commitment.addCapacity('user2');
                test.expect(triggered2).toBeTruthy();
            });

            test.test('should provide recommendation reasons', () => {
                const capacity = new EnhancedCapacity('user1');
                capacity.addOffering('music', 0.8);
                capacity.receiveSkillEndorsement('user2', 'music', 0.9);
                capacity.reputation = 1.6;
                
                const commitment = new IntegratedCommitment(1, 'Music jam session', 'Park', 2);
                const reasons = capacity.getRecommendationReasons(commitment);
                test.expect(reasons.length > 0).toBeTruthy();
            });

            test.test('should create mock services', () => {
                const grassroots = new MockGrassrootsService();
                const freeAssoc = new MockFreeAssociationService();
                const telegram = new MockTelegramService();
                test.expect(grassroots.connected).toBeTruthy();
                test.expect(freeAssoc.connected).toBeTruthy();
                test.expect(telegram.connected).toBeTruthy();
            });

            test.displayResults();
        }

        // ====================
        // APPLICATION STARTUP
        // ====================

        console.log('üöÄ Starting Integrated Crowdsurfing App...');

        // Run tests
        runIntegratedTests();

        // Initialize the application
        const app = new IntegratedCrowdsurfingApp();
        const ui = new IntegratedUIController(app);

        console.log('üéä Integrated Crowdsurfing App initialized!');
        console.log('üå± Grassroots Economics: Demurrage-based value decay');
        console.log('üîó Free Association: Intelligent skill matching');
        console.log('ü§ù Holons Bot: Offer coordination (simulated offline)');
        console.log('üì± Telegram: Automatic group creation');

        // Update UI periodically
        setInterval(() => {
            app.updateNotificationBadge();
            if (ui.currentScreen === 'map-screen') {
                ui.updateMapView();
            }
        }, 5000);
    

ui.handleMultiEntry = function(event, type) {
  if (event.key === 'Enter' || event.key === ',') {
    event.preventDefault();
    const input = event.target;
    const value = input.value.trim();
    if (value) {
      const container = document.getElementById(`${type}-tags`);
      const tag = document.createElement('div');
      tag.className = 'entry-tag';
      tag.innerHTML = `${value} <span class="remove-tag" onclick="ui.removeTag(this)">√ó</span>`;
      container.appendChild(tag);
      input.value = '';
    }
  }
};

ui.removeTag = function(el) {
  el.parentNode.remove();
};

ui.getTags = function(type) {
  const container = document.getElementById(`${type}-tags`);
  return Array.from(container.children).map(tag => tag.textContent.slice(0, -1).trim());
};

ui.showIntentScreen = function() {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById('intent-screen').classList.add('active');
};



ui.createCommitment = function () {
  console.log("üìå createCommitment triggered");

  const text = document.getElementById("commitment-text").value.trim();
  const location = document.getElementById("commitment-location").value.trim();
  const threshold = parseInt(document.getElementById("commitment-threshold").value);
  const demurrageRate = parseFloat(document.getElementById("demurrage-rate").value);
  const duration = document.getElementById("activity-duration").value;

  if (!text || !location || isNaN(threshold)) {
    alert("Please fill in all required fields.");
    return;
  }

  const id = `cmt-${Date.now()}`;
  const newCommitment = new IntegratedCommitment(id, text, location, threshold, demurrageRate, appState.user?.userId || "anon");
  newCommitment.activityDuration = duration;

  appState.commitments.set(id, newCommitment);
  appState.lastCreatedCommitment = newCommitment;

  appState.updateState('COMMITMENT_CREATED', newCommitment);

  console.log("‚úÖ Commitment created, showing intent screen...");
  ui.showIntentScreen();
};

ui.showIntentScreen = function () {
  console.log("üß≠ showIntentScreen triggered");
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  const intentScreen = document.getElementById('intent-screen');
  if (intentScreen) {
    intentScreen.classList.add('active');
    console.log("üöÄ Intent screen activated");
  } else {
    console.warn("‚ùå Intent screen not found in DOM");
  }
};
</script></body>
</html>